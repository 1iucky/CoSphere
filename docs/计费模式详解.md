# New API 计费模式详解：倍率 vs 价格

> **文档目的**: 深入解析项目中的两种计费模式及其设计考虑
> **最后更新**: 2025-11-29

---

## 📊 两种计费模式对比

### 1. 倍率计费（Ratio-based Billing）

**核心概念**：
- 使用"配额"作为虚拟货币单位
- 通过倍率将 token 消耗转换为配额消耗
- 配额 = Token 数量 × 模型倍率 × 分组倍率

**计费公式**：
```
文本对话配额 = (输入 tokens + 输出 tokens × 补全倍率) × 模型倍率 × 分组倍率

音频配额 = (文本 tokens + 文本 tokens × 补全倍率
          + 音频 tokens × 音频倍率
          + 音频 tokens × 音频倍率 × 音频补全倍率) × 模型倍率 × 分组倍率
```

**示例**：
```
用户请求 GPT-4：
- 输入: 1000 tokens
- 输出: 500 tokens
- 模型倍率: 15.0 (GPT-4 较贵)
- 分组倍率: 1.2 (VIP 用户)
- 补全倍率: 1.0 (默认)

配额消耗 = (1000 + 500 × 1.0) × 15.0 × 1.2 = 27,000 配额
```

---

### 2. 价格计费（Price-based Billing）

**核心概念**：
- 直接使用官方价格（美元/百万 tokens）
- 配额与真实货币挂钩
- 配额 = 美元价格 × 配额单位换算 × 分组倍率

**计费公式**：
```
配额 = (输入 tokens × 输入价格 + 输出 tokens × 输出价格)
     × 配额单位换算系数
     × 分组倍率

其中：
- 输入价格/输出价格：官方定价（USD/1M tokens）
- 配额单位换算：通常是 500,000（即 $1 = 500,000 配额）
- 分组倍率：用户组加价系数
```

**示例**：
```
用户请求 GPT-4：
- 输入: 1000 tokens
- 输出: 500 tokens
- 输入价格: $0.03/1K tokens = $30/1M tokens
- 输出价格: $0.06/1K tokens = $60/1M tokens
- 配额单位: 500,000
- 分组倍率: 1.2 (VIP 加价 20%)

配额消耗 = ((1000/1M × 30) + (500/1M × 60)) × 500,000 × 1.2
        = (0.03 + 0.03) × 500,000 × 1.2
        = 36,000 配额
```

---

## 🔍 核心区别

| 维度 | 倍率计费 | 价格计费 |
|------|---------|---------|
| **基准单位** | 配额（虚拟货币） | 美元价格 |
| **价格来源** | 人工设定倍率 | OpenAI 官方价格 |
| **调整方式** | 修改倍率系数 | 同步官方价格 |
| **透明度** | 🟡 较低（需要理解倍率含义） | 🟢 高（直接对应官方价格） |
| **灵活性** | 🟢 高（可任意调整倍率） | 🟡 中（受限于官方价格） |
| **维护成本** | 🟢 低（倍率相对稳定） | 🔴 高（需频繁同步官方价格） |
| **用户理解难度** | 🔴 较难（需要换算） | 🟢 简单（直接对应真实价格） |
| **适用场景** | 内部使用、灵活定价 | 对外服务、透明计费 |

---

## 💡 为什么要使用倍率计费？

### 优势 1：简化定价管理 ✅

**问题场景**：
OpenAI 的模型定价经常变动，不同模型的输入/输出价格也不同。

**倍率解决方案**：
- 设定一个基准（如 GPT-3.5-turbo = 1.0 倍率）
- 其他模型相对基准设定倍率
  - GPT-4: 15x
  - GPT-4-32k: 30x
  - Claude-3-opus: 20x

**好处**：
```
✅ 官方价格变动时，只需调整基准价格，所有模型自动跟随
✅ 无需维护每个模型的输入/输出价格
✅ 新增模型时只需设定一个倍率值
```

---

### 优势 2：支持灵活定价策略 ✅

**场景 1：VIP 用户折扣**
```
普通用户：分组倍率 = 1.0
VIP 用户：分组倍率 = 0.8 (8 折)
企业用户：分组倍率 = 0.6 (6 折)
```

**场景 2：差异化定价**
```
某些模型官方价格很低，但你想收取更高费用：
- 官方 GPT-3.5-turbo: $0.002/1K tokens
- 你的定价：倍率 × 3 = 实际 3 倍价格
```

**场景 3：按分组定价**
```
用户组 A 访问 gpt-4：GroupRatio = 1.0
用户组 B 访问 gpt-4：GroupRatio = 1.5 (加价 50%)
```

---

### 优势 3：统一内部货币体系 ✅

**问题**：
项目支持 30+ AI 提供商，每个提供商的定价标准不同：
- OpenAI: $/百万 tokens
- Claude: $/百万 tokens，但 cache 有折扣
- Gemini: $/百万 tokens，但分 Flash/Pro 价格不同
- 国内模型: 有的按次计费，有的按 token 计费

**倍率统一方案**：
```
所有模型统一转换为"配额"消耗：
- 1 配额 = 0.002 美元（可配置）
- 用户充值 ¥100 = 获得 70,000 配额
- 所有模型消耗都用配额结算

好处：
✅ 用户只需关心"配额"，不用理解各个模型的复杂定价
✅ 系统内部统一结算，避免汇率波动
✅ 方便做预算控制和额度管理
```

---

### 优势 4：降低维护成本 ✅

**价格计费的维护成本**：
```
❌ 需要维护每个模型的官方价格数据库
❌ OpenAI 价格变动时需要手动同步
❌ 不同提供商的价格格式不统一，需要适配
❌ 新模型发布时需要及时添加价格
```

**倍率计费的维护成本**：
```
✅ 只需维护一个倍率表
✅ 倍率相对稳定，不需要频繁更新
✅ 新模型只需参考类似模型设定倍率
✅ 可以快速调整定价策略
```

---

## ⚠️ 倍率计费的缺点

### 缺点 1：用户理解难度 ❌

**问题**：
用户看到"消耗 27,000 配额"，不知道这相当于多少钱。

**对比**：
```
倍率计费显示：
"本次请求消耗 27,000 配额"

价格计费显示：
"本次请求消耗 $0.054 (约 ¥0.39)"
```

**用户困惑**：
- ❓ 27,000 配额值多少钱？
- ❓ 和官方 OpenAI 比，是贵了还是便宜了？
- ❓ 为什么同样的请求，配额消耗不一样？

---

### 缺点 2：缺乏价格透明度 ❌

**问题**：
用户无法直接将配额消耗与真实成本对应。

**示例**：
```
用户 A 在官网看到：
"GPT-4 输入 $0.03/1K tokens，输出 $0.06/1K tokens"

用户 A 在你的平台看到：
"GPT-4 模型倍率 15.0，分组倍率 1.2"

用户心理：
😕 "我到底花了多少钱？"
😕 "比官方贵了多少？"
😕 "为什么不直接显示价格？"
```

---

### 缺点 3：容易被误解为不透明 ❌

**用户可能的想法**：
```
❌ "倍率这么高，是不是平台在乱收费？"
❌ "为什么不用官方价格，是不是有猫腻？"
❌ "配额计费太复杂，我看不懂"
```

**信任问题**：
- 用户可能认为平台故意模糊价格
- 对比其他平台时，无法直接比价
- 企业用户更倾向于"看得懂"的计费方式

---

## 🎯 最佳实践建议

### 方案 1：双模式并存 ⭐⭐⭐⭐⭐ (推荐)

**实现**：
```go
// 代码中已支持
type QuotaInfo struct {
    UsePrice   bool    // 是否使用价格计费
    ModelPrice float64 // 官方模型价格
    ModelRatio float64 // 模型倍率
    GroupRatio float64 // 分组倍率
}

if info.UsePrice {
    // 价格计费模式
    quota = modelPrice × quotaPerUnit × groupRatio
} else {
    // 倍率计费模式
    quota = tokens × modelRatio × groupRatio
}
```

**适用场景**：
```
内部用户/测试环境：使用倍率计费（灵活、简单）
对外服务/企业客户：使用价格计费（透明、可信）
```

---

### 方案 2：倍率 + 透明化展示 ⭐⭐⭐⭐

**核心**：使用倍率计费，但向用户透明展示价格换算。

**前端展示优化**：

**当前显示**：
```
✅ 模型: gpt-4
✅ 输入 tokens: 1,000
✅ 输出 tokens: 500
✅ 配额消耗: 27,000
```

**优化后显示**：
```
✅ 模型: gpt-4
✅ 输入 tokens: 1,000 (官方价格: $0.03)
✅ 输出 tokens: 500 (官方价格: $0.03)
✅ 官方总价: $0.06
✅ 平台倍率: 1.5x (包含运营成本)
✅ 实际收费: $0.09 (约 ¥0.65)
✅ 配额消耗: 27,000 配额
💡 说明: 1 配额 ≈ $0.000002
```

**好处**：
- ✅ 保留倍率计费的灵活性
- ✅ 提升价格透明度
- ✅ 用户可以自己计算和验证
- ✅ 清楚了解平台加价情况

---

### 方案 3：价格计费 + 配额作为积分 ⭐⭐⭐

**核心**：使用价格计费，配额作为充值赠送的"积分"。

**计费逻辑**：
```
用户充值：
- 充值 ¥100 → 获得 $14 + 赠送 10,000 配额积分

消费扣费：
1. 优先使用赠送的配额积分
2. 配额不足时，按官方价格从美元余额扣费

好处：
✅ 计费透明（直接扣美元）
✅ 保留配额激励机制（充值赠送）
✅ 用户清楚知道花了多少钱
```

---

## 📈 项目实际应用分析

### 当前项目的计费设计

**代码分析**：
```go
// service/quota.go:50-87
func calculateAudioQuota(info QuotaInfo) int {
    if info.UsePrice {
        // 价格计费模式
        modelPrice := decimal.NewFromFloat(info.ModelPrice)
        quotaPerUnit := decimal.NewFromFloat(common.QuotaPerUnit)
        groupRatio := decimal.NewFromFloat(info.GroupRatio)

        quota := modelPrice.Mul(quotaPerUnit).Mul(groupRatio)
        return int(quota.IntPart())
    }

    // 倍率计费模式
    modelRatio := decimal.NewFromFloat(info.ModelRatio)
    groupRatio := decimal.NewFromFloat(info.GroupRatio)
    ratio := groupRatio.Mul(modelRatio)

    quota := tokens.Mul(ratio)
    return int(quota.Round(0).IntPart())
}
```

**项目特点**：
- ✅ **双模式支持**：同时支持倍率和价格计费
- ✅ **可配置切换**：每个渠道可独立选择计费模式
- ✅ **精确计算**：使用 decimal 避免浮点误差
- ✅ **灵活加价**：分组倍率支持差异化定价

---

## 💰 实际计费对比示例

### 场景：用户使用 GPT-4 生成 1000 字文章

**官方价格**（OpenAI）：
```
输入: 500 tokens × $0.03/1K = $0.015
输出: 2000 tokens × $0.06/1K = $0.120
总计: $0.135 (约 ¥0.97)
```

---

**倍率计费**（假设）：
```
配置:
- GPT-4 模型倍率: 15.0
- VIP 分组倍率: 1.2
- 配额单位: 1 配额 = $0.000002

计算:
输入配额 = 500 × 15.0 × 1.2 = 9,000
输出配额 = 2000 × 15.0 × 1.2 = 36,000
总配额 = 45,000

价格 = 45,000 × $0.000002 = $0.09 (约 ¥0.65)

结论: 比官方便宜了 33%
```

---

**价格计费**（假设）：
```
配置:
- 输入价格: $30/1M tokens (官方)
- 输出价格: $60/1M tokens (官方)
- 分组倍率: 1.2 (VIP 加价 20%)
- 配额单位: 500,000

计算:
配额 = ((500/1M × 30) + (2000/1M × 60)) × 500,000 × 1.2
     = (0.015 + 0.120) × 500,000 × 1.2
     = 81,000

价格 = 81,000 / 500,000 = $0.162 (约 ¥1.16)

结论: 比官方贵了 20% (符合分组倍率)
```

---

## 🎨 前端展示优化建议

### 优化 1：消费明细页面

**当前**：
```
日期         模型      tokens   配额
2025-01-29  gpt-4     1500     27,000
```

**优化后**：
```
日期         模型      输入      输出      官方价格   平台价格   配额
2025-01-29  gpt-4    1000t    500t     $0.06     $0.09     27,000
                    ($0.03)  ($0.03)

💡 点击展开详情：
   - 模型倍率: 15.0
   - 分组倍率: 1.2 (VIP 折扣)
   - 补全倍率: 1.0
   - 配额单位: 1 配额 = $0.000002
```

---

### 优化 2：实时消费提示

**当前**：
```
✅ 请求成功
消耗配额: 27,000
```

**优化后**：
```
✅ 请求成功
━━━━━━━━━━━━━━━━━━━━━━
📊 消费明细:
   输入: 1,000 tokens
   输出: 500 tokens

💰 费用:
   官方价格: $0.06
   平台收费: $0.09 (1.5x)
   配额消耗: 27,000

📈 剩余:
   账户余额: 973,000 配额 (约 $1.95)
```

---

### 优化 3：定价说明页面

**新增页面**：`/pricing-explanation`

```markdown
# 计费说明

## 我们的计费方式

本平台使用"配额"作为统一的消费单位。

### 什么是配额？

配额是平台的虚拟货币，用于统一管理不同 AI 模型的消费。

1 配额 ≈ $0.000002 (约 ¥0.000014)

### 为什么不直接用美元计费？

1. **统一体验**: 支持 30+ AI 提供商，配额简化了计费
2. **灵活优惠**: 方便实施折扣、赠送等营销活动
3. **稳定价格**: 汇率波动不影响配额价值

### 价格对比

| 模型 | 官方价格 | 平台倍率 | 实际价格 | 说明 |
|------|---------|---------|---------|------|
| GPT-3.5-turbo | $0.002/1K | 1.0x | $0.002/1K | 与官方持平 |
| GPT-4 | $0.03/1K (in) | 1.5x | $0.045/1K | 包含运营成本 |
| Claude-3 | $0.015/1K (in) | 1.3x | $0.0195/1K | 包含转发成本 |

### VIP 用户优惠

- 普通用户: 标准倍率
- VIP 用户: 0.8x 倍率 (8 折)
- 企业用户: 0.6x 倍率 (6 折)
```

---

## 🔧 技术实现建议

### 1. 在日志中记录详细信息

```go
// service/log_info_generate.go
func GenerateTextOtherInfo(...) map[string]interface{} {
    other := make(map[string]interface{})

    if usePrice {
        // 价格计费
        other["billing_mode"] = "price"
        other["official_price"] = modelPrice
        other["platform_price"] = modelPrice * groupRatio
        other["group_ratio"] = groupRatio
        other["price_comparison"] = fmt.Sprintf("%.2fx", groupRatio)
    } else {
        // 倍率计费
        other["billing_mode"] = "ratio"
        other["model_ratio"] = modelRatio
        other["group_ratio"] = groupRatio
        other["completion_ratio"] = completionRatio

        // 新增：计算等效官方价格
        officialPrice := calculateOfficialPrice(tokens, modelName)
        other["official_price_estimate"] = officialPrice
        other["platform_price"] = officialPrice * modelRatio * groupRatio
        other["total_ratio"] = modelRatio * groupRatio
    }

    return other
}
```

---

### 2. 前端展示组件

```javascript
// web/src/components/common/QuotaDisplay.jsx
const QuotaDisplay = ({ quota, tokens, modelName, billingMode, ratios }) => {
  // 计算等效价格
  const officialPrice = calculateOfficialPrice(tokens, modelName);
  const platformPrice = billingMode === 'price'
    ? officialPrice * ratios.groupRatio
    : officialPrice * ratios.modelRatio * ratios.groupRatio;

  return (
    <Card>
      <div className="quota-display">
        <div className="primary-info">
          <span className="quota-amount">{quota.toLocaleString()}</span>
          <span className="quota-label">配额</span>
        </div>

        <Divider />

        <div className="price-breakdown">
          <div className="price-row">
            <span>官方价格:</span>
            <span>${officialPrice.toFixed(4)}</span>
          </div>

          <div className="price-row">
            <span>平台收费:</span>
            <span>${platformPrice.toFixed(4)}</span>
            <Tag color="blue">
              {((platformPrice / officialPrice) * 100).toFixed(0)}%
            </Tag>
          </div>

          {billingMode === 'ratio' && (
            <div className="ratio-info">
              <Collapse>
                <Collapse.Panel header="计费详情">
                  <p>模型倍率: {ratios.modelRatio}x</p>
                  <p>分组倍率: {ratios.groupRatio}x</p>
                  <p>总倍率: {(ratios.modelRatio * ratios.groupRatio).toFixed(2)}x</p>
                </Collapse.Panel>
              </Collapse>
            </div>
          )}
        </div>

        <div className="conversion-info">
          <small>
            💡 1 配额 ≈ ${(1 / common.QuotaPerUnit).toFixed(6)}
          </small>
        </div>
      </div>
    </Card>
  );
};
```

---

## 📊 总结与建议

### 倍率计费的定位

**适合场景**：
- ✅ 内部系统、企业内部使用
- ✅ 需要灵活调整定价策略
- ✅ 维护成本有限
- ✅ 用户群体固定，可以做好培训

**不适合场景**：
- ❌ 面向普通消费者的公开服务
- ❌ 需要与竞品直接比价
- ❌ 用户对价格敏感度高
- ❌ 追求极致透明度

---

### 最终建议 🎯

**对于 New API 项目**：

1. **保留双模式** ⭐⭐⭐⭐⭐
   - 内部测试/开发环境：倍率计费
   - 对外商业服务：价格计费
   - 让用户自主选择计费模式

2. **提升透明度** ⭐⭐⭐⭐⭐
   - 在所有地方同时显示配额和美元价格
   - 提供详细的计费说明页面
   - 日志中记录完整的计费详情
   - 支持"价格预估"功能

3. **优化用户体验** ⭐⭐⭐⭐
   - 实时显示等效官方价格
   - 提供价格对比功能
   - 支持配额到价格的在线转换器
   - 清晰说明平台加价的原因（运营成本、服务保障等）

4. **增加配置灵活性** ⭐⭐⭐⭐
   ```go
   // 系统设置
   type BillingConfig struct {
       DefaultMode      string  // "ratio" or "price"
       AllowUserChoice  bool    // 是否允许用户选择计费模式
       ShowPriceBreakdown bool  // 是否显示价格明细
       QuotaPerUnit     float64 // 配额单位换算
   }
   ```

---

## 📝 实施清单

**短期（1-2 周）**：
- [ ] 在消费日志中同时显示配额和价格
- [ ] 添加计费说明页面
- [ ] 优化前端消费明细展示

**中期（1 个月）**：
- [ ] 实现价格对比功能
- [ ] 添加在线价格计算器
- [ ] 完善 API 文档中的计费说明

**长期（2-3 个月）**：
- [ ] 支持用户自主选择计费模式
- [ ] 实现智能定价建议
- [ ] 添加成本分析报表

---

**文档版本**: 1.0
**最后更新**: 2025-11-29
**作者**: Claude
