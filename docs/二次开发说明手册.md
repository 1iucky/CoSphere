# New API é¡¹ç›®äºŒæ¬¡å¼€å‘å®Œæ•´æŒ‡å—

> **é¡¹ç›®åç§°**: New API - æ–°ä¸€ä»£å¤§æ¨¡å‹ç½‘å…³ä¸AIèµ„äº§ç®¡ç†ç³»ç»Ÿ
> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2025-11-29
> **é¡¹ç›®åœ°å€**: https://github.com/QuantumNous/new-api

---

## ğŸ“š ç›®å½•

- [ä¸€ã€é¡¹ç›®æ¦‚è§ˆ](#ä¸€é¡¹ç›®æ¦‚è§ˆ)
- [äºŒã€é¡¹ç›®æ¶æ„](#äºŒé¡¹ç›®æ¶æ„)
- [ä¸‰ã€å¼€å‘ç¯å¢ƒæ­å»º](#ä¸‰å¼€å‘ç¯å¢ƒæ­å»º)
- [å››ã€åç«¯å¼€å‘æŒ‡å—](#å››åç«¯å¼€å‘æŒ‡å—)
- [äº”ã€å‰ç«¯å¼€å‘æŒ‡å—](#äº”å‰ç«¯å¼€å‘æŒ‡å—)
- [å…­ã€æ•°æ®åº“è®¾è®¡](#å…­æ•°æ®åº“è®¾è®¡)
- [ä¸ƒã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹](#ä¸ƒæ ¸å¿ƒä¸šåŠ¡æµç¨‹)
- [å…«ã€æ‰©å±•å¼€å‘æŒ‡å—](#å…«æ‰©å±•å¼€å‘æŒ‡å—)
- [ä¹ã€éƒ¨ç½²ä¸è¿ç»´](#ä¹éƒ¨ç½²ä¸è¿ç»´)
- [åã€å¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ](#åå¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ)

---

## ä¸€ã€é¡¹ç›®æ¦‚è§ˆ

### 1.1 é¡¹ç›®ç®€ä»‹

**New API** æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å¤§æ¨¡å‹ç½‘å…³ç³»ç»Ÿï¼Œæä¾›ç»Ÿä¸€çš„ AI API æ¥å…¥æ–¹æ¡ˆï¼Œæ”¯æŒ 30+ AI æ¨¡å‹æä¾›å•†ï¼Œå…·å¤‡å®Œå–„çš„æƒé™ç®¡ç†ã€è®¡è´¹ç³»ç»Ÿå’Œç›‘æ§åŠŸèƒ½ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **ç»Ÿä¸€æ¥å£**: ä¸€ä¸ª API å¯†é’¥è®¿é—®å¤šä¸ª AI æ¨¡å‹æä¾›å•†
- ğŸ’° **çµæ´»è®¡è´¹**: æ”¯æŒæŒ‰å€ç‡/ä»·æ ¼è®¡è´¹ï¼Œç¼“å­˜ä¼˜æƒ 
- ğŸ”’ **æƒé™ç®¡ç†**: ç»†ç²’åº¦çš„ç”¨æˆ·/ä»¤ç‰Œ/æ¨¡å‹æƒé™æ§åˆ¶
- ğŸš€ **é«˜å¯ç”¨**: å¤šæ¸ é“è´Ÿè½½å‡è¡¡ã€è‡ªåŠ¨é‡è¯•ã€æ•…éšœåˆ‡æ¢
- ğŸ“Š **å¯è§‚æµ‹**: å®Œå–„çš„æ—¥å¿—ã€ç›‘æ§ã€ç»Ÿè®¡åŠŸèƒ½

### 1.2 æŠ€æœ¯æ ˆæ€»è§ˆ

**åç«¯æŠ€æœ¯æ ˆ** (æ ¹ç›®å½•)ï¼š
```
- è¯­è¨€: Go 1.25.1
- Webæ¡†æ¶: Gin 1.9.1
- ORM: GORM
- æ•°æ®åº“: PostgreSQL (ä¸») / MySQL / SQLite
- ç¼“å­˜: Redis
- è®¤è¯: JWT + Session + OAuth2
```

**å‰ç«¯æŠ€æœ¯æ ˆ** (web/)ï¼š
```
- æ¡†æ¶: React 18.2
- æ„å»ºå·¥å…·: Vite 5.2
- UI åº“: Semi Design 2.69
- æ ·å¼: Tailwind CSS 3
- è·¯ç”±: React Router 6
- HTTP: Axios 1.12
- å›½é™…åŒ–: i18next
- å›¾è¡¨: VChart 1.8
```

### 1.3 é¡¹ç›®ç‰¹æ€§

**ä¸šåŠ¡åŠŸèƒ½**ï¼š
- âœ… 30+ AI æ¨¡å‹æä¾›å•†æ”¯æŒï¼ˆOpenAIã€Claudeã€Geminiã€å›½å†…å¤§æ¨¡å‹ç­‰ï¼‰
- âœ… å¤šæ¸ é“ç®¡ç†ï¼ˆCRUDã€æ‰¹é‡æ“ä½œã€æ¨¡å‹æµ‹è¯•ã€è‡ªåŠ¨ç¦ç”¨ï¼‰
- âœ… ç”¨æˆ·ç®¡ç†ï¼ˆè§’è‰²æƒé™ã€åˆ†ç»„ç®¡ç†ã€é…é¢ç®¡ç†ï¼‰
- âœ… Token ç®¡ç†ï¼ˆæ¨¡å‹é™åˆ¶ã€IP ç™½åå•ã€è¿‡æœŸæ—¶é—´ï¼‰
- âœ… çµæ´»è®¡è´¹ï¼ˆæŒ‰å€ç‡/æŒ‰ä»·æ ¼ã€ç¼“å­˜ä¼˜æƒ ã€åˆ†ç»„å€ç‡ï¼‰
- âœ… å®Œå–„æ—¥å¿—ï¼ˆæ¶ˆè´¹æ—¥å¿—ã€é”™è¯¯æ—¥å¿—ã€ç»Ÿè®¡åˆ†æï¼‰
- âœ… åœ¨çº¿å……å€¼ï¼ˆæ˜“æ”¯ä»˜ã€Stripeï¼‰
- âœ… OAuth ç™»å½•ï¼ˆGitHubã€Discordã€OIDCã€LinuxDOã€Telegramï¼‰
- âœ… åŒå› ç´ è®¤è¯ï¼ˆTOTPã€Passkeyï¼‰
- âœ… ä»ªè¡¨ç›˜ï¼ˆæ•°æ®æ¦‚è§ˆã€å›¾è¡¨å±•ç¤ºã€å®æ—¶ç›‘æ§ï¼‰
- âœ… AI å¯¹è¯å®éªŒåœºï¼ˆå‚æ•°è°ƒèŠ‚ã€è°ƒè¯•ã€é…ç½®ç®¡ç†ï¼‰

**æŠ€æœ¯ç‰¹æ€§**ï¼š
- âœ… è¯·æ±‚ä¸­ç»§ä¸æ ¼å¼è½¬æ¢ï¼ˆOpenAI â‡„ Claude â‡„ Geminiï¼‰
- âœ… å¤šå¯†é’¥ç®¡ç†ï¼ˆè½®è¯¢/éšæœºæ¨¡å¼ã€çŠ¶æ€è¿½è¸ªï¼‰
- âœ… æ™ºèƒ½è·¯ç”±ï¼ˆåŠ æƒéšæœºã€å¤±è´¥é‡è¯•ã€è‡ªåŠ¨åˆ‡æ¢ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆå…¨å±€/ç”¨æˆ·/æ¨¡å‹çº§åˆ«ï¼‰
- âœ… ç¼“å­˜æœºåˆ¶ï¼ˆRedis/å†…å­˜ç¼“å­˜ï¼‰
- âœ… WebSocket æ”¯æŒï¼ˆå®æ—¶å¯¹è¯ APIï¼‰
- âœ… å¼‚æ­¥ä»»åŠ¡ï¼ˆMidjourneyã€è§†é¢‘ç”Ÿæˆï¼‰
- âœ… å›½é™…åŒ–ï¼ˆ6 ç§è¯­è¨€ï¼‰

---

## äºŒã€é¡¹ç›®æ¶æ„

### 2.1 Monorepo æ¶æ„

```
CoSphere/
â”œâ”€â”€ æ ¹ç›®å½•/                    # åç«¯ Go é¡¹ç›®
â”‚   â”œâ”€â”€ main.go               # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ controller/           # æ§åˆ¶å™¨å±‚ (44ä¸ª)
â”‚   â”œâ”€â”€ service/              # ä¸šåŠ¡é€»è¾‘å±‚ (24ä¸ª)
â”‚   â”œâ”€â”€ model/                # æ•°æ®æ¨¡å‹å±‚ (27ä¸ª)
â”‚   â”œâ”€â”€ relay/                # AIæ¨¡å‹ä¸­ç»§æœåŠ¡
â”‚   â”‚   â””â”€â”€ channel/         # 30+ å‚å•†é€‚é…å™¨
â”‚   â”œâ”€â”€ middleware/           # ä¸­é—´ä»¶ (18ä¸ª)
â”‚   â”œâ”€â”€ router/               # è·¯ç”±é…ç½® (6ä¸ª)
â”‚   â”œâ”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡ (23ä¸ª)
â”‚   â”œâ”€â”€ common/               # é€šç”¨å·¥å…· (35ä¸ª)
â”‚   â”œâ”€â”€ constant/             # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ types/                # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ setting/              # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ logger/               # æ—¥å¿—ç³»ç»Ÿ
â”‚
â””â”€â”€ web/                      # å‰ç«¯ React é¡¹ç›®
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ components/      # UI ç»„ä»¶ (201ä¸ª)
    â”‚   â”œâ”€â”€ pages/           # é¡µé¢ç»„ä»¶ (49ä¸ª)
    â”‚   â”œâ”€â”€ hooks/           # è‡ªå®šä¹‰ Hooks (31ä¸ª)
    â”‚   â”œâ”€â”€ helpers/         # å·¥å…·å‡½æ•° (16ä¸ª)
    â”‚   â”œâ”€â”€ context/         # çŠ¶æ€ç®¡ç† (Context API)
    â”‚   â”œâ”€â”€ constants/       # å¸¸é‡å®šä¹‰ (11ä¸ª)
    â”‚   â”œâ”€â”€ services/        # API æœåŠ¡å±‚
    â”‚   â””â”€â”€ i18n/            # å›½é™…åŒ– (6ç§è¯­è¨€)
    â””â”€â”€ public/              # é™æ€èµ„æº
```

### 2.2 åç«¯åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HTTP Request (Client)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Middleware Layer (ä¸­é—´ä»¶å±‚)          â”‚
â”‚  - Auth (è®¤è¯)                               â”‚
â”‚  - Rate Limit (é™æµ)                        â”‚
â”‚  - Distributor (æ¸ é“åˆ†å‘)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Controller Layer (æ§åˆ¶å™¨å±‚)           â”‚
â”‚  - HTTP è¯·æ±‚å¤„ç†                             â”‚
â”‚  - å‚æ•°éªŒè¯                                  â”‚
â”‚  - å“åº”æ ¼å¼åŒ–                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Service Layer (ä¸šåŠ¡é€»è¾‘å±‚)           â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å®ç°                              â”‚
â”‚  - æ•°æ®å¤„ç†                                  â”‚
â”‚  - ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Model Layer (æ•°æ®æ¨¡å‹å±‚)            â”‚
â”‚  - æ•°æ®æ¨¡å‹å®šä¹‰                              â”‚
â”‚  - æ•°æ®åº“æ“ä½œ                                â”‚
â”‚  - ç¼“å­˜ç®¡ç†                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Database (PostgreSQL/MySQL/SQLite)    â”‚
â”‚       Cache (Redis)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å‰ç«¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Pages (é¡µé¢å±‚)                  â”‚
â”‚  - è·¯ç”±ç»„ä»¶                                  â”‚
â”‚  - é¡µé¢å¸ƒå±€                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Components (ç»„ä»¶å±‚)                â”‚
â”‚  - UI ç»„ä»¶                                   â”‚
â”‚  - ä¸šåŠ¡ç»„ä»¶                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Hooks (é€»è¾‘å±‚)                   â”‚
â”‚  - çŠ¶æ€ç®¡ç†                                  â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘                                  â”‚
â”‚  - å‰¯ä½œç”¨å¤„ç†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Context (å…¨å±€çŠ¶æ€)                  â”‚
â”‚  - UserContext                              â”‚
â”‚  - StatusContext                            â”‚
â”‚  - ThemeContext                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            API Layer (APIå±‚)                â”‚
â”‚  - axios é…ç½®                                â”‚
â”‚  - è¯·æ±‚æ‹¦æˆª                                  â”‚
â”‚  - å“åº”æ‹¦æˆª                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Backend API (åç«¯æ¥å£)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 ä¸­ç»§æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Client Request (OpenAI Format)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Distributor Middleware              â”‚
â”‚  - é€‰æ‹©æ¸ é“ (Channel Selection)             â”‚
â”‚  - æƒé‡åˆ†é… (Weight Distribution)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Relay Handler                     â”‚
â”‚  - text_handler (æ–‡æœ¬å¯¹è¯)                  â”‚
â”‚  - image_handler (å›¾åƒç”Ÿæˆ)                 â”‚
â”‚  - audio_handler (éŸ³é¢‘å¤„ç†)                 â”‚
â”‚  - embedding_handler (å‘é‡åŒ–)               â”‚
â”‚  - rerank_handler (é‡æ’åº)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Channel Adaptor                    â”‚
â”‚  - OpenAI Adaptor                           â”‚
â”‚  - Claude Adaptor                           â”‚
â”‚  - Gemini Adaptor                           â”‚
â”‚  - é˜¿é‡Œäº‘ Adaptor                            â”‚
â”‚  - ... (30+ å‚å•†)                            â”‚
â”‚                                             â”‚
â”‚  åŠŸèƒ½:                                       â”‚
â”‚  - ConvertRequest (æ ¼å¼è½¬æ¢)                â”‚
â”‚  - SetupRequestHeader (è®¾ç½®è®¤è¯)            â”‚
â”‚  - DoRequest (å‘é€è¯·æ±‚)                     â”‚
â”‚  - DoResponse (å¤„ç†å“åº”)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Upstream AI Provider (ä¸Šæ¸¸æœåŠ¡å•†)       â”‚
â”‚  - OpenAI API                               â”‚
â”‚  - Anthropic API                            â”‚
â”‚  - Google Gemini API                        â”‚
â”‚  - é˜¿é‡Œé€šä¹‰åƒé—® API                          â”‚
â”‚  - ... (30+ æä¾›å•†)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Response Processing               â”‚
â”‚  - è½¬æ¢ä¸º OpenAI æ ¼å¼                        â”‚
â”‚  - é…é¢è®¡è´¹                                  â”‚
â”‚  - æ—¥å¿—è®°å½•                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Return to Client                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å¼€å‘ç¯å¢ƒæ­å»º

### 3.1 ç¯å¢ƒè¦æ±‚

**åç«¯å¼€å‘ç¯å¢ƒ**ï¼š
- Go 1.25.1 æˆ–æ›´é«˜ç‰ˆæœ¬
- PostgreSQL 9.6+ / MySQL 5.7.8+ / SQLite 3
- Redis 5.0+ï¼ˆå¯é€‰ï¼Œç”¨äºç¼“å­˜ï¼‰
- Git

**å‰ç«¯å¼€å‘ç¯å¢ƒ**ï¼š
- Node.js 16+ æˆ– Bun 1.0+
- npm / yarn / pnpm / bun

**å¼€å‘å·¥å…·æ¨è**ï¼š
- IDE: GoLand / VS Code
- API æµ‹è¯•: Postman / Apifox
- æ•°æ®åº“å·¥å…·: DBeaver / Navicat
- Git å®¢æˆ·ç«¯: SourceTree / GitKraken

### 3.2 é¡¹ç›®å…‹éš†ä¸å®‰è£…

**1. å…‹éš†é¡¹ç›®**
```bash
git clone https://github.com/QuantumNous/new-api.git
cd new-api
```

**2. é…ç½®ç¯å¢ƒå˜é‡**
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

**å…³é”®ç¯å¢ƒå˜é‡è¯´æ˜**ï¼š
```bash
# æ•°æ®åº“é…ç½®
SQL_DSN=postgres://user:pass@localhost:5432/newapi?sslmode=disable

# Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
REDIS_CONN_STRING=redis://localhost:6379

# ä¼šè¯å¯†é’¥ï¼ˆå¤šæœºéƒ¨ç½²å¿…é¡»ï¼‰
SESSION_SECRET=your_random_secret_key

# åŠ å¯†å¯†é’¥ï¼ˆä½¿ç”¨ Redis å¿…é¡»ï¼‰
CRYPTO_SECRET=your_crypto_secret_key

# æœåŠ¡ç«¯å£
PORT=3000

# æ—¥å¿—é…ç½®
ERROR_LOG_ENABLED=true
LOG_CONSUME_ENABLED=true

# Azure API ç‰ˆæœ¬
AZURE_DEFAULT_API_VERSION=2025-04-01-preview

# æµå¼è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
STREAMING_TIMEOUT=300
```

**3. å®‰è£…åç«¯ä¾èµ–**
```bash
# å®‰è£… Go ä¾èµ–
go mod download
```

**4. åˆå§‹åŒ–æ•°æ®åº“**
```bash
# è‡ªåŠ¨åˆ›å»ºæ•°æ®è¡¨
# é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“
go run main.go
```

**5. å®‰è£…å‰ç«¯ä¾èµ–**
```bash
cd web

# ä½¿ç”¨ npm
npm install

# æˆ–ä½¿ç”¨ bun (æ¨è)
bun install
```

### 3.3 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

**å¯åŠ¨åç«¯**ï¼š
```bash
# å¼€å‘æ¨¡å¼ï¼ˆå¸¦è°ƒè¯•æ—¥å¿—ï¼‰
GIN_MODE=debug go run main.go

# ç”Ÿäº§æ¨¡å¼
go run main.go

# ä½¿ç”¨ Air çƒ­é‡è½½ï¼ˆæ¨èï¼‰
air
```

**å¯åŠ¨å‰ç«¯**ï¼š
```bash
cd web

# ä½¿ç”¨ npm
npm run dev

# ä½¿ç”¨ bun
bun dev
```

è®¿é—®åœ°å€ï¼š
- å‰ç«¯å¼€å‘æœåŠ¡å™¨: http://localhost:5173
- åç«¯ API æœåŠ¡: http://localhost:3000
- API æ–‡æ¡£: http://localhost:3000/api/docs (å¦‚æœé…ç½®äº†)

**é»˜è®¤ç®¡ç†å‘˜è´¦å·**ï¼š
```
ç”¨æˆ·å: root
å¯†ç : 123456
```

âš ï¸ **é‡è¦**: é¦–æ¬¡ç™»å½•åè¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼

### 3.4 å¼€å‘å·¥å…·é…ç½®

**VS Code æ¨èæ’ä»¶**ï¼š
```json
{
  "recommendations": [
    "golang.go",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "dsznajder.es7-react-js-snippets"
  ]
}
```

**GoLand é…ç½®**ï¼š
- å¯ç”¨ Go Modules
- è®¾ç½® GOROOT å’Œ GOPATH
- é…ç½® File Watchers (gofmt, goimports)

---

## å››ã€åç«¯å¼€å‘æŒ‡å—

### 4.1 ç›®å½•ç»“æ„è¯¦è§£

```
åç«¯æ ¹ç›®å½•/
â”œâ”€â”€ main.go                   # åº”ç”¨å…¥å£ï¼Œåˆå§‹åŒ–å„æ¨¡å—
â”œâ”€â”€ controller/               # æ§åˆ¶å™¨å±‚ (44ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ user.go              # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ token.go             # Token ç®¡ç†
â”‚   â”œâ”€â”€ channel.go           # æ¸ é“ç®¡ç†
â”‚   â”œâ”€â”€ relay.go             # è¯·æ±‚ä¸­ç»§
â”‚   â”œâ”€â”€ log.go               # æ—¥å¿—æŸ¥è¯¢
â”‚   â”œâ”€â”€ ...                  # æ›´å¤šæ§åˆ¶å™¨
â”‚
â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚ (24ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ quota.go             # é…é¢ç®¡ç†
â”‚   â”œâ”€â”€ channel.go           # æ¸ é“ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ channel_select.go    # æ¸ é“é€‰æ‹©ç­–ç•¥
â”‚   â”œâ”€â”€ user_notify.go       # ç”¨æˆ·é€šçŸ¥
â”‚   â”œâ”€â”€ ...                  # æ›´å¤šæœåŠ¡
â”‚
â”œâ”€â”€ model/                    # æ•°æ®æ¨¡å‹å±‚ (27ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ main.go              # æ•°æ®åº“åˆå§‹åŒ–
â”‚   â”œâ”€â”€ user.go              # ç”¨æˆ·æ¨¡å‹
â”‚   â”œâ”€â”€ token.go             # Token æ¨¡å‹
â”‚   â”œâ”€â”€ channel.go           # æ¸ é“æ¨¡å‹
â”‚   â”œâ”€â”€ log.go               # æ—¥å¿—æ¨¡å‹
â”‚   â”œâ”€â”€ channel_cache.go     # æ¸ é“ç¼“å­˜
â”‚   â”œâ”€â”€ ...                  # æ›´å¤šæ¨¡å‹
â”‚
â”œâ”€â”€ relay/                    # ä¸­ç»§æœåŠ¡
â”‚   â”œâ”€â”€ text_handler.go      # æ–‡æœ¬å¯¹è¯å¤„ç†
â”‚   â”œâ”€â”€ image_handler.go     # å›¾åƒç”Ÿæˆå¤„ç†
â”‚   â”œâ”€â”€ audio_handler.go     # éŸ³é¢‘å¤„ç†
â”‚   â”œâ”€â”€ embedding_handler.go # Embedding å¤„ç†
â”‚   â””â”€â”€ channel/             # å‚å•†é€‚é…å™¨
â”‚       â”œâ”€â”€ adapter.go       # é€‚é…å™¨æ¥å£
â”‚       â”œâ”€â”€ openai/          # OpenAI é€‚é…å™¨
â”‚       â”œâ”€â”€ claude/          # Claude é€‚é…å™¨
â”‚       â”œâ”€â”€ gemini/          # Gemini é€‚é…å™¨
â”‚       â”œâ”€â”€ ali/             # é˜¿é‡Œé€šä¹‰é€‚é…å™¨
â”‚       â””â”€â”€ ...              # 30+ å‚å•†é€‚é…å™¨
â”‚
â”œâ”€â”€ middleware/               # ä¸­é—´ä»¶ (18ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ auth.go              # è®¤è¯ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ distributor.go       # æ¸ é“åˆ†å‘
â”‚   â”œâ”€â”€ rate-limit.go        # é€Ÿç‡é™åˆ¶
â”‚   â”œâ”€â”€ model-rate-limit.go  # æ¨¡å‹çº§é™æµ
â”‚   â”œâ”€â”€ logger.go            # æ—¥å¿—è®°å½•
â”‚   â””â”€â”€ ...                  # æ›´å¤šä¸­é—´ä»¶
â”‚
â”œâ”€â”€ router/                   # è·¯ç”±é…ç½® (6ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ main.go              # è·¯ç”±æ€»å…¥å£
â”‚   â”œâ”€â”€ api-router.go        # ç®¡ç† API è·¯ç”±
â”‚   â”œâ”€â”€ relay-router.go      # ä¸­ç»§ API è·¯ç”±
â”‚   â”œâ”€â”€ video-router.go      # è§†é¢‘è·¯ç”±
â”‚   â””â”€â”€ ...                  # æ›´å¤šè·¯ç”±
â”‚
â”œâ”€â”€ dto/                      # æ•°æ®ä¼ è¾“å¯¹è±¡ (23ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ openai_request.go    # OpenAI è¯·æ±‚ DTO
â”‚   â”œâ”€â”€ openai_response.go   # OpenAI å“åº” DTO
â”‚   â”œâ”€â”€ claude.go            # Claude DTO
â”‚   â”œâ”€â”€ gemini.go            # Gemini DTO
â”‚   â””â”€â”€ ...                  # æ›´å¤š DTO
â”‚
â”œâ”€â”€ common/                   # é€šç”¨å·¥å…· (35ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ database.go          # æ•°æ®åº“å·¥å…·
â”‚   â”œâ”€â”€ redis.go             # Redis å·¥å…·
â”‚   â”œâ”€â”€ str.go               # å­—ç¬¦ä¸²å·¥å…·
â”‚   â”œâ”€â”€ hash.go              # å“ˆå¸Œå·¥å…·
â”‚   â”œâ”€â”€ crypto.go            # åŠ å¯†å·¥å…·
â”‚   â”œâ”€â”€ email.go             # é‚®ä»¶æœåŠ¡
â”‚   â”œâ”€â”€ totp.go              # TOTP åŒå› ç´ 
â”‚   â””â”€â”€ ...                  # æ›´å¤šå·¥å…·
â”‚
â”œâ”€â”€ constant/                 # å¸¸é‡å®šä¹‰
â”‚   â””â”€â”€ constants.go         # ç³»ç»Ÿå¸¸é‡
â”‚
â”œâ”€â”€ types/                    # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ types.go             # è‡ªå®šä¹‰ç±»å‹
â”‚
â”œâ”€â”€ setting/                  # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ ratio_setting/       # å€ç‡é…ç½®
â”‚
â””â”€â”€ logger/                   # æ—¥å¿—ç³»ç»Ÿ
    â””â”€â”€ logger.go            # æ—¥å¿—é…ç½®
```

### 4.2 æ·»åŠ æ–°çš„ AI æä¾›å•†é€‚é…å™¨

**åœºæ™¯**: å‡è®¾ä½ è¦æ·»åŠ å¯¹ "NewAI" æä¾›å•†çš„æ”¯æŒã€‚

**æ­¥éª¤ 1: åˆ›å»ºé€‚é…å™¨ç›®å½•å’Œæ–‡ä»¶**

```bash
mkdir -p relay/channel/newai
cd relay/channel/newai
touch adaptor.go main.go
```

**æ­¥éª¤ 2: å®ç°é€‚é…å™¨æ¥å£ (adaptor.go)**

```go
package newai

import (
    "github.com/QuantumNous/new-api/relay/channel"
    "github.com/QuantumNous/new-api/relay/common"
    "github.com/QuantumNous/new-api/dto"
    "github.com/QuantumNous/new-api/types"
    "github.com/gin-gonic/gin"
    "io"
    "net/http"
)

type Adaptor struct {
    // é€‚é…å™¨é…ç½®
}

// åˆå§‹åŒ–é€‚é…å™¨
func (a *Adaptor) Init(info *common.RelayInfo) {
    // åˆå§‹åŒ–é€»è¾‘
}

// è·å–è¯·æ±‚ URL
func (a *Adaptor) GetRequestURL(info *common.RelayInfo) (string, error) {
    // æ„å»ºä¸Šæ¸¸ API URL
    baseURL := info.BaseUrl
    if baseURL == "" {
        baseURL = "https://api.newai.com"
    }
    return fmt.Sprintf("%s/v1/chat/completions", baseURL), nil
}

// è®¾ç½®è¯·æ±‚å¤´
func (a *Adaptor) SetupRequestHeader(c *gin.Context, req *http.Header, info *common.RelayInfo) error {
    // è®¾ç½®è®¤è¯å¤´
    req.Set("Authorization", "Bearer "+info.ApiKey)
    req.Set("Content-Type", "application/json")
    return nil
}

// è½¬æ¢ OpenAI è¯·æ±‚ä¸º NewAI æ ¼å¼
func (a *Adaptor) ConvertOpenAIRequest(c *gin.Context, relayMode int, request *dto.GeneralOpenAIRequest) (any, error) {
    // å¦‚æœæ ¼å¼ç›¸åŒï¼Œç›´æ¥è¿”å›
    if relayMode == relay.RelayModeOpenAI {
        return request, nil
    }

    // å¦åˆ™è¿›è¡Œæ ¼å¼è½¬æ¢
    newAIRequest := &NewAIRequest{
        Model:    request.Model,
        Messages: request.Messages,
        Stream:   request.Stream,
        // ... å…¶ä»–å­—æ®µè½¬æ¢
    }
    return newAIRequest, nil
}

// å‘é€è¯·æ±‚
func (a *Adaptor) DoRequest(c *gin.Context, info *common.RelayInfo, requestBody io.Reader) (any, error) {
    // å‘é€ HTTP è¯·æ±‚åˆ°ä¸Šæ¸¸
    url, _ := a.GetRequestURL(info)
    req, _ := http.NewRequest("POST", url, requestBody)

    a.SetupRequestHeader(c, &req.Header, info)

    client := &http.Client{}
    resp, err := client.Do(req)
    if err != nil {
        return nil, err
    }

    return resp, nil
}

// å¤„ç†å“åº”
func (a *Adaptor) DoResponse(c *gin.Context, resp *http.Response, info *common.RelayInfo) (usage any, err *types.NewAPIError) {
    // è§£æå“åº”
    var newAIResp NewAIResponse
    if err := json.NewDecoder(resp.Body).Decode(&newAIResp); err != nil {
        return nil, types.NewAPIError(500, "failed to decode response")
    }

    // è½¬æ¢ä¸º OpenAI æ ¼å¼
    openAIResp := &dto.ChatCompletionsResponse{
        Id:      newAIResp.Id,
        Object:  "chat.completion",
        Created: newAIResp.Created,
        Model:   newAIResp.Model,
        Choices: convertChoices(newAIResp.Choices),
        Usage:   convertUsage(newAIResp.Usage),
    }

    // è¿”å›ç»™å®¢æˆ·ç«¯
    c.JSON(200, openAIResp)

    return openAIResp.Usage, nil
}

// è·å–æ¨¡å‹åˆ—è¡¨
func (a *Adaptor) GetModelList() []string {
    return []string{
        "newai-chat-v1",
        "newai-chat-v2",
    }
}

// è·å–æ¸ é“åç§°
func (a *Adaptor) GetChannelName() string {
    return "newai"
}
```

**æ­¥éª¤ 3: å®šä¹‰ NewAI ä¸“ç”¨æ•°æ®ç»“æ„ (main.go)**

```go
package newai

type NewAIRequest struct {
    Model    string                 `json:"model"`
    Messages []NewAIMessage         `json:"messages"`
    Stream   bool                   `json:"stream,omitempty"`
    // ... å…¶ä»– NewAI ç‰¹æœ‰å­—æ®µ
}

type NewAIMessage struct {
    Role    string `json:"role"`
    Content string `json:"content"`
}

type NewAIResponse struct {
    Id      string          `json:"id"`
    Created int64           `json:"created"`
    Model   string          `json:"model"`
    Choices []NewAIChoice   `json:"choices"`
    Usage   NewAIUsage      `json:"usage"`
}

type NewAIChoice struct {
    Index   int            `json:"index"`
    Message NewAIMessage   `json:"message"`
}

type NewAIUsage struct {
    PromptTokens     int `json:"prompt_tokens"`
    CompletionTokens int `json:"completion_tokens"`
    TotalTokens      int `json:"total_tokens"`
}
```

**æ­¥éª¤ 4: æ³¨å†Œé€‚é…å™¨**

åœ¨ `relay/channel/adapter.go` ä¸­æ·»åŠ ï¼š

```go
const (
    // ... å…¶ä»–å¸¸é‡
    ChannelTypeNewAI = 99  // é€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„ç¼–å·
)

func GetAdaptor(apiType int) Adaptor {
    switch apiType {
    // ... å…¶ä»– case
    case ChannelTypeNewAI:
        return &newai.Adaptor{}
    default:
        return &openai.Adaptor{}
    }
}
```

**æ­¥éª¤ 5: æ·»åŠ åˆ°å¸¸é‡å®šä¹‰**

åœ¨ `constant/constants.go` ä¸­æ·»åŠ ï¼š

```go
const (
    // ... å…¶ä»–å¸¸é‡
    ChannelTypeNewAI = 99
)

var ChannelBaseURLs = map[int]string{
    // ... å…¶ä»–æ˜ å°„
    ChannelTypeNewAI: "https://api.newai.com",
}
```

**æ­¥éª¤ 6: å‰ç«¯æ·»åŠ æ¸ é“ç±»å‹é€‰é¡¹**

åœ¨ `web/src/constants/channel.constants.js` ä¸­æ·»åŠ ï¼š

```javascript
export const CHANNEL_OPTIONS = [
  // ... å…¶ä»–é€‰é¡¹
  { key: 99, text: 'NewAI', value: 99, color: 'blue' }
];
```

**æ­¥éª¤ 7: æµ‹è¯•é€‚é…å™¨**

```bash
# é‡æ–°ç¼–è¯‘åç«¯
go build -o new-api main.go

# å¯åŠ¨æœåŠ¡
./new-api

# åœ¨ç®¡ç†åå°æ·»åŠ  NewAI æ¸ é“
# æµ‹è¯•å¯¹è¯æ¥å£
curl -X POST http://localhost:3000/v1/chat/completions \
  -H "Authorization: Bearer sk-your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "newai-chat-v1",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

### 4.3 æ·»åŠ æ–°çš„æ§åˆ¶å™¨

**åœºæ™¯**: æ·»åŠ ä¸€ä¸ª"ä¼˜æƒ åˆ¸ç®¡ç†"åŠŸèƒ½ã€‚

**æ­¥éª¤ 1: åˆ›å»ºæ•°æ®æ¨¡å‹ (model/coupon.go)**

```go
package model

import "gorm.io/gorm"

type Coupon struct {
    Id          int            `json:"id"`
    Code        string         `json:"code" gorm:"uniqueIndex"`
    Discount    int            `json:"discount"`    // æŠ˜æ‰£é¢åº¦
    MaxUses     int            `json:"max_uses"`    // æœ€å¤§ä½¿ç”¨æ¬¡æ•°
    UsedCount   int            `json:"used_count"`  // å·²ä½¿ç”¨æ¬¡æ•°
    ExpiredTime int64          `json:"expired_time" gorm:"bigint"`
    Status      int            `json:"status" gorm:"default:1"`
    CreatedTime int64          `json:"created_time" gorm:"bigint"`
    DeletedAt   gorm.DeletedAt `gorm:"index"`
}

// è·å–æ‰€æœ‰ä¼˜æƒ åˆ¸
func GetAllCoupons(startIdx int, num int) ([]*Coupon, error) {
    var coupons []*Coupon
    err := DB.Order("id desc").Limit(num).Offset(startIdx).Find(&coupons).Error
    return coupons, err
}

// æ ¹æ® ID è·å–ä¼˜æƒ åˆ¸
func GetCouponById(id int) (*Coupon, error) {
    var coupon Coupon
    err := DB.First(&coupon, id).Error
    return &coupon, err
}

// æ ¹æ® Code è·å–ä¼˜æƒ åˆ¸
func GetCouponByCode(code string) (*Coupon, error) {
    var coupon Coupon
    err := DB.Where("code = ?", code).First(&coupon).Error
    return &coupon, err
}

// åˆ›å»ºä¼˜æƒ åˆ¸
func (coupon *Coupon) Insert() error {
    return DB.Create(coupon).Error
}

// æ›´æ–°ä¼˜æƒ åˆ¸
func (coupon *Coupon) Update() error {
    return DB.Save(coupon).Error
}

// åˆ é™¤ä¼˜æƒ åˆ¸
func (coupon *Coupon) Delete() error {
    return DB.Delete(coupon).Error
}
```

**æ­¥éª¤ 2: åˆ›å»ºæœåŠ¡å±‚ (service/coupon.go)**

```go
package service

import (
    "errors"
    "github.com/QuantumNous/new-api/model"
    "github.com/QuantumNous/new-api/common"
)

// ä½¿ç”¨ä¼˜æƒ åˆ¸
func UseCoupon(userId int, code string) (int, error) {
    // è·å–ä¼˜æƒ åˆ¸
    coupon, err := model.GetCouponByCode(code)
    if err != nil {
        return 0, errors.New("ä¼˜æƒ åˆ¸ä¸å­˜åœ¨")
    }

    // æ£€æŸ¥çŠ¶æ€
    if coupon.Status != common.CouponStatusEnabled {
        return 0, errors.New("ä¼˜æƒ åˆ¸å·²ç¦ç”¨")
    }

    // æ£€æŸ¥è¿‡æœŸæ—¶é—´
    if coupon.ExpiredTime != -1 && coupon.ExpiredTime < common.GetTimestamp() {
        return 0, errors.New("ä¼˜æƒ åˆ¸å·²è¿‡æœŸ")
    }

    // æ£€æŸ¥ä½¿ç”¨æ¬¡æ•°
    if coupon.MaxUses != -1 && coupon.UsedCount >= coupon.MaxUses {
        return 0, errors.New("ä¼˜æƒ åˆ¸å·²è¾¾åˆ°æœ€å¤§ä½¿ç”¨æ¬¡æ•°")
    }

    // å¢åŠ ç”¨æˆ·é…é¢
    err = model.IncreaseUserQuota(userId, coupon.Discount)
    if err != nil {
        return 0, errors.New("å¢åŠ é…é¢å¤±è´¥")
    }

    // æ›´æ–°ä¼˜æƒ åˆ¸ä½¿ç”¨æ¬¡æ•°
    coupon.UsedCount++
    err = coupon.Update()
    if err != nil {
        return 0, errors.New("æ›´æ–°ä¼˜æƒ åˆ¸å¤±è´¥")
    }

    // è®°å½•æ—¥å¿—
    model.RecordLog(userId, model.LogTypeTopup,
        fmt.Sprintf("ä½¿ç”¨ä¼˜æƒ åˆ¸ %sï¼Œè·å¾— %d é…é¢", code, coupon.Discount))

    return coupon.Discount, nil
}
```

**æ­¥éª¤ 3: åˆ›å»ºæ§åˆ¶å™¨ (controller/coupon.go)**

```go
package controller

import (
    "net/http"
    "strconv"
    "github.com/QuantumNous/new-api/common"
    "github.com/QuantumNous/new-api/model"
    "github.com/QuantumNous/new-api/service"
    "github.com/gin-gonic/gin"
)

// è·å–æ‰€æœ‰ä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜ï¼‰
func GetAllCoupons(c *gin.Context) {
    p, _ := strconv.Atoi(c.Query("p"))
    if p < 0 {
        p = 0
    }

    coupons, err := model.GetAllCoupons(p*common.ItemsPerPage, common.ItemsPerPage)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to get coupons"))
        return
    }

    c.JSON(http.StatusOK, common.ApiSuccess(gin.H{
        "coupons": coupons,
    }))
}

// åˆ›å»ºä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜ï¼‰
func CreateCoupon(c *gin.Context) {
    var coupon model.Coupon
    err := c.ShouldBindJSON(&coupon)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("invalid parameter"))
        return
    }

    coupon.CreatedTime = common.GetTimestamp()
    err = coupon.Insert()
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to create coupon"))
        return
    }

    c.JSON(http.StatusOK, common.ApiSuccess(nil))
}

// æ›´æ–°ä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜ï¼‰
func UpdateCoupon(c *gin.Context) {
    var coupon model.Coupon
    err := c.ShouldBindJSON(&coupon)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("invalid parameter"))
        return
    }

    err = coupon.Update()
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to update coupon"))
        return
    }

    c.JSON(http.StatusOK, common.ApiSuccess(nil))
}

// åˆ é™¤ä¼˜æƒ åˆ¸ï¼ˆç®¡ç†å‘˜ï¼‰
func DeleteCoupon(c *gin.Context) {
    id, _ := strconv.Atoi(c.Param("id"))
    coupon, err := model.GetCouponById(id)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("coupon not found"))
        return
    }

    err = coupon.Delete()
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to delete coupon"))
        return
    }

    c.JSON(http.StatusOK, common.ApiSuccess(nil))
}

// ä½¿ç”¨ä¼˜æƒ åˆ¸ï¼ˆç”¨æˆ·ï¼‰
func UseCoupon(c *gin.Context) {
    userId := c.GetInt("id")
    code := c.PostForm("code")

    if code == "" {
        c.JSON(http.StatusOK, common.ApiError("code is required"))
        return
    }

    discount, err := service.UseCoupon(userId, code)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError(err.Error()))
        return
    }

    c.JSON(http.StatusOK, common.ApiSuccess(gin.H{
        "discount": discount,
    }))
}
```

**æ­¥éª¤ 4: æ·»åŠ è·¯ç”± (router/api-router.go)**

```go
// åœ¨ SetApiRouter å‡½æ•°ä¸­æ·»åŠ 
func SetApiRouter(router *gin.Engine) {
    // ... å…¶ä»–è·¯ç”±

    // ä¼˜æƒ åˆ¸ç®¡ç†è·¯ç”±ï¼ˆç®¡ç†å‘˜ï¼‰
    apiRouter.GET("/coupon", middleware.AdminAuth(), controller.GetAllCoupons)
    apiRouter.POST("/coupon", middleware.AdminAuth(), controller.CreateCoupon)
    apiRouter.PUT("/coupon", middleware.AdminAuth(), controller.UpdateCoupon)
    apiRouter.DELETE("/coupon/:id", middleware.AdminAuth(), controller.DeleteCoupon)

    // ä¼˜æƒ åˆ¸ä½¿ç”¨è·¯ç”±ï¼ˆç”¨æˆ·ï¼‰
    apiRouter.POST("/coupon/use", middleware.UserAuth(), controller.UseCoupon)
}
```

**æ­¥éª¤ 5: æ•°æ®åº“è¿ç§»**

```go
// åœ¨ model/main.go çš„ InitDB() å‡½æ•°ä¸­æ·»åŠ 
func InitDB() error {
    // ... å…¶ä»–è¿ç§»

    err = DB.AutoMigrate(&Coupon{})
    if err != nil {
        return err
    }

    // ...
}
```

### 4.4 æ·»åŠ è‡ªå®šä¹‰ä¸­é—´ä»¶

**åœºæ™¯**: æ·»åŠ ä¸€ä¸ª IP é»‘åå•ä¸­é—´ä»¶ã€‚

```go
// middleware/ip_blacklist.go
package middleware

import (
    "net/http"
    "github.com/QuantumNous/new-api/common"
    "github.com/gin-gonic/gin"
)

var blacklistIPs = map[string]bool{
    "192.168.1.100": true,
    "10.0.0.50": true,
}

func IPBlacklist() gin.HandlerFunc {
    return func(c *gin.Context) {
        clientIP := c.ClientIP()

        if blacklistIPs[clientIP] {
            c.JSON(http.StatusForbidden, common.ApiError("IP blocked"))
            c.Abort()
            return
        }

        c.Next()
    }
}

// åŠ¨æ€æ·»åŠ  IP åˆ°é»‘åå•
func AddToBlacklist(ip string) {
    blacklistIPs[ip] = true
}

// ä»é»‘åå•ç§»é™¤ IP
func RemoveFromBlacklist(ip string) {
    delete(blacklistIPs, ip)
}
```

**ä½¿ç”¨ä¸­é—´ä»¶**ï¼š

```go
// router/api-router.go
func SetApiRouter(router *gin.Engine) {
    // å…¨å±€åº”ç”¨ IP é»‘åå•ä¸­é—´ä»¶
    router.Use(middleware.IPBlacklist())

    // ... å…¶ä»–è·¯ç”±
}
```

---

## äº”ã€å‰ç«¯å¼€å‘æŒ‡å—

### 5.1 ç›®å½•ç»“æ„è¯¦è§£

```
web/src/
â”œâ”€â”€ App.jsx                   # è·¯ç”±é…ç½®å’Œåº”ç”¨å…¥å£
â”œâ”€â”€ index.jsx                 # React æ¸²æŸ“å…¥å£
â”œâ”€â”€ index.css                 # å…¨å±€æ ·å¼
â”‚
â”œâ”€â”€ components/               # ç»„ä»¶åº“ (201ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ auth/                # è®¤è¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ LoginForm.jsx
â”‚   â”‚   â”œâ”€â”€ RegisterForm.jsx
â”‚   â”‚   â””â”€â”€ TwoFAVerification.jsx
â”‚   â”‚
â”‚   â”œâ”€â”€ common/              # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/              # åŸºç¡€ UI
â”‚   â”‚   â”œâ”€â”€ markdown/        # Markdown æ¸²æŸ“
â”‚   â”‚   â””â”€â”€ modals/          # æ¨¡æ€æ¡†
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/           # ä»ªè¡¨ç›˜ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ index.jsx
â”‚   â”‚   â”œâ”€â”€ StatsCards.jsx
â”‚   â”‚   â”œâ”€â”€ ChartsPanel.jsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ layout/              # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ PageLayout.jsx
â”‚   â”‚   â”œâ”€â”€ SiderBar.jsx
â”‚   â”‚   â””â”€â”€ headerbar/
â”‚   â”‚
â”‚   â”œâ”€â”€ playground/          # AI å¯¹è¯å®éªŒåœº
â”‚   â”‚   â”œâ”€â”€ ChatArea.jsx
â”‚   â”‚   â”œâ”€â”€ SettingsPanel.jsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ settings/            # è®¾ç½®ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ SystemSetting.jsx
â”‚   â”‚   â”œâ”€â”€ PersonalSetting.jsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ table/               # è¡¨æ ¼ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ channels/        # æ¸ é“ç®¡ç†è¡¨æ ¼
â”‚   â”‚   â”œâ”€â”€ tokens/          # Token ç®¡ç†è¡¨æ ¼
â”‚   â”‚   â”œâ”€â”€ users/           # ç”¨æˆ·ç®¡ç†è¡¨æ ¼
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ topup/               # å……å€¼ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ RechargeCard.jsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ setup/               # å®‰è£…å‘å¯¼
â”‚       â””â”€â”€ SetupWizard.jsx
â”‚
â”œâ”€â”€ pages/                    # é¡µé¢ç»„ä»¶ (49ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ Home/                # é¦–é¡µ
â”‚   â”œâ”€â”€ Dashboard/           # æ§åˆ¶å°
â”‚   â”œâ”€â”€ Channel/             # æ¸ é“ç®¡ç†
â”‚   â”œâ”€â”€ Token/               # Token ç®¡ç†
â”‚   â”œâ”€â”€ User/                # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ Playground/          # AI å¯¹è¯
â”‚   â”œâ”€â”€ Setting/             # ç³»ç»Ÿè®¾ç½®
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ hooks/                    # è‡ªå®šä¹‰ Hooks (31ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ common/              # é€šç”¨ Hooks
â”‚   â”‚   â”œâ”€â”€ useIsMobile.js
â”‚   â”‚   â”œâ”€â”€ useNotifications.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/           # ä»ªè¡¨ç›˜ Hooks
â”‚   â”‚   â”œâ”€â”€ useDashboardData.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ channels/            # æ¸ é“ç®¡ç† Hooks
â”‚   â”‚   â””â”€â”€ useChannelsData.jsx
â”‚   â”‚
â”‚   â””â”€â”€ ...                  # æ›´å¤šåŠŸèƒ½ Hooks
â”‚
â”œâ”€â”€ helpers/                  # å·¥å…·å‡½æ•° (16ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ api.js               # API é…ç½®å’Œå·¥å…·
â”‚   â”œâ”€â”€ utils.jsx            # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ auth.jsx             # è®¤è¯å·¥å…·
â”‚   â”œâ”€â”€ render.jsx           # æ¸²æŸ“å·¥å…·
â”‚   â”œâ”€â”€ dashboard.jsx        # ä»ªè¡¨ç›˜å·¥å…·
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ context/                  # çŠ¶æ€ç®¡ç† (Context API)
â”‚   â”œâ”€â”€ User/                # ç”¨æˆ·çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ index.jsx
â”‚   â”‚   â””â”€â”€ reducer.js
â”‚   â”‚
â”‚   â”œâ”€â”€ Status/              # ç³»ç»ŸçŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ index.jsx
â”‚   â”‚   â””â”€â”€ reducer.js
â”‚   â”‚
â”‚   â””â”€â”€ Theme/               # ä¸»é¢˜çŠ¶æ€
â”‚       â””â”€â”€ index.jsx
â”‚
â”œâ”€â”€ constants/                # å¸¸é‡å®šä¹‰ (11ä¸ªæ–‡ä»¶)
â”‚   â”œâ”€â”€ common.constant.js
â”‚   â”œâ”€â”€ channel.constants.js
â”‚   â”œâ”€â”€ user.constants.js
â”‚   â”œâ”€â”€ dashboard.constants.js
â”‚   â”œâ”€â”€ playground.constants.js
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ services/                 # API æœåŠ¡å±‚
â”‚   â””â”€â”€ secureVerification.js
â”‚
â””â”€â”€ i18n/                     # å›½é™…åŒ–
    â”œâ”€â”€ i18n.js              # i18next é…ç½®
    â””â”€â”€ locales/
        â”œâ”€â”€ zh.json          # ç®€ä½“ä¸­æ–‡
        â”œâ”€â”€ en.json          # è‹±æ–‡
        â”œâ”€â”€ ja.json          # æ—¥è¯­
        â”œâ”€â”€ ru.json          # ä¿„è¯­
        â”œâ”€â”€ vi.json          # è¶Šå—è¯­
        â””â”€â”€ fr.json          # æ³•è¯­
```

### 5.2 æ·»åŠ æ–°é¡µé¢

**åœºæ™¯**: æ·»åŠ "ä¼˜æƒ åˆ¸ç®¡ç†"é¡µé¢ã€‚

**æ­¥éª¤ 1: åˆ›å»ºé¡µé¢ç»„ä»¶ (pages/Coupon/index.jsx)**

```javascript
import React from 'react';
import { useCouponsData } from '../../hooks/coupons/useCouponsData';
import CouponsPage from '../../components/table/coupons';

const Coupon = () => {
  const couponsData = useCouponsData();
  return <CouponsPage {...couponsData} />;
};

export default Coupon;
```

**æ­¥éª¤ 2: åˆ›å»ºè‡ªå®šä¹‰ Hook (hooks/coupons/useCouponsData.jsx)**

```javascript
import { useState, useEffect } from 'react';
import { API, showError, showSuccess } from '../../helpers';
import { Toast } from '@douyinfe/semi-ui';

export const useCouponsData = () => {
  // çŠ¶æ€ç®¡ç†
  const [coupons, setCoupons] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activePage, setActivePage] = useState(1);
  const [showEdit, setShowEdit] = useState(false);
  const [editingCoupon, setEditingCoupon] = useState({});

  // åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨
  const loadCoupons = async (page = 1) => {
    setLoading(true);
    try {
      const res = await API.get('/api/coupon', {
        params: { p: page - 1 }
      });
      const { success, data, message } = res.data;
      if (success) {
        setCoupons(data.coupons || []);
        setActivePage(page);
      } else {
        showError(message);
      }
    } catch (error) {
      showError(error);
    } finally {
      setLoading(false);
    }
  };

  // åˆ›å»º/æ›´æ–°ä¼˜æƒ åˆ¸
  const handleSubmit = async (coupon) => {
    try {
      const res = await API[coupon.id ? 'put' : 'post']('/api/coupon', coupon);
      const { success, message } = res.data;
      if (success) {
        showSuccess(coupon.id ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ');
        setShowEdit(false);
        loadCoupons(activePage);
      } else {
        showError(message);
      }
    } catch (error) {
      showError(error);
    }
  };

  // åˆ é™¤ä¼˜æƒ åˆ¸
  const handleDelete = async (id) => {
    try {
      const res = await API.delete(`/api/coupon/${id}`);
      const { success, message } = res.data;
      if (success) {
        showSuccess('åˆ é™¤æˆåŠŸ');
        loadCoupons(activePage);
      } else {
        showError(message);
      }
    } catch (error) {
      showError(error);
    }
  };

  // ç¼–è¾‘ä¼˜æƒ åˆ¸
  const handleEdit = (coupon) => {
    setEditingCoupon(coupon);
    setShowEdit(true);
  };

  // æ–°å»ºä¼˜æƒ åˆ¸
  const handleAdd = () => {
    setEditingCoupon({});
    setShowEdit(true);
  };

  // åˆå§‹åŒ–åŠ è½½
  useEffect(() => {
    loadCoupons();
  }, []);

  return {
    coupons,
    loading,
    activePage,
    showEdit,
    editingCoupon,
    loadCoupons,
    handleSubmit,
    handleDelete,
    handleEdit,
    handleAdd,
    setShowEdit,
  };
};
```

**æ­¥éª¤ 3: åˆ›å»ºè¡¨æ ¼ç»„ä»¶ (components/table/coupons/index.jsx)**

```javascript
import React from 'react';
import { Card, Table, Button, Space, Modal } from '@douyinfe/semi-ui';
import { IconPlus, IconRefresh } from '@douyinfe/semi-icons';
import EditCouponModal from './modals/EditCouponModal';

const CouponsPage = (props) => {
  const {
    coupons,
    loading,
    activePage,
    showEdit,
    editingCoupon,
    loadCoupons,
    handleSubmit,
    handleDelete,
    handleEdit,
    handleAdd,
    setShowEdit,
  } = props;

  // è¡¨æ ¼åˆ—å®šä¹‰
  const columns = [
    {
      title: 'ID',
      dataIndex: 'id',
      width: 80,
    },
    {
      title: 'ä¼˜æƒ åˆ¸ä»£ç ',
      dataIndex: 'code',
    },
    {
      title: 'æŠ˜æ‰£é¢åº¦',
      dataIndex: 'discount',
      render: (discount) => `${discount} é…é¢`,
    },
    {
      title: 'ä½¿ç”¨æƒ…å†µ',
      dataIndex: 'used_count',
      render: (used, record) => {
        if (record.max_uses === -1) {
          return `${used} / æ— é™`;
        }
        return `${used} / ${record.max_uses}`;
      },
    },
    {
      title: 'è¿‡æœŸæ—¶é—´',
      dataIndex: 'expired_time',
      render: (time) => {
        if (time === -1) return 'æ°¸ä¸è¿‡æœŸ';
        return new Date(time * 1000).toLocaleString();
      },
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      render: (status) => {
        return status === 1 ? 'å¯ç”¨' : 'ç¦ç”¨';
      },
    },
    {
      title: 'æ“ä½œ',
      dataIndex: 'id',
      render: (id, record) => (
        <Space>
          <Button
            size='small'
            onClick={() => handleEdit(record)}
          >
            ç¼–è¾‘
          </Button>
          <Button
            size='small'
            type='danger'
            onClick={() => {
              Modal.confirm({
                title: 'ç¡®è®¤åˆ é™¤',
                content: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼˜æƒ åˆ¸å—?',
                onOk: () => handleDelete(id),
              });
            }}
          >
            åˆ é™¤
          </Button>
        </Space>
      ),
    },
  ];

  return (
    <Card
      title='ä¼˜æƒ åˆ¸ç®¡ç†'
      headerExtraContent={
        <Space>
          <Button
            icon={<IconPlus />}
            onClick={handleAdd}
          >
            æ–°å»ºä¼˜æƒ åˆ¸
          </Button>
          <Button
            icon={<IconRefresh />}
            onClick={() => loadCoupons(activePage)}
          />
        </Space>
      }
    >
      <Table
        columns={columns}
        dataSource={coupons}
        loading={loading}
        pagination={{
          currentPage: activePage,
          pageSize: 10,
          onPageChange: loadCoupons,
        }}
      />

      {/* ç¼–è¾‘æ¨¡æ€æ¡† */}
      <EditCouponModal
        visible={showEdit}
        coupon={editingCoupon}
        onSubmit={handleSubmit}
        onCancel={() => setShowEdit(false)}
      />
    </Card>
  );
};

export default CouponsPage;
```

**æ­¥éª¤ 4: åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡† (components/table/coupons/modals/EditCouponModal.jsx)**

```javascript
import React, { useEffect, useState } from 'react';
import { Modal, Form, Input, InputNumber, Select, Switch } from '@douyinfe/semi-ui';

const EditCouponModal = ({ visible, coupon, onSubmit, onCancel }) => {
  const [formApi, setFormApi] = useState(null);

  // å½“ coupon å˜åŒ–æ—¶ï¼Œæ›´æ–°è¡¨å•
  useEffect(() => {
    if (formApi && coupon) {
      formApi.setValues(coupon);
    }
  }, [coupon, formApi]);

  const handleOk = () => {
    formApi.validate().then((values) => {
      onSubmit(values);
    });
  };

  return (
    <Modal
      title={coupon.id ? 'ç¼–è¾‘ä¼˜æƒ åˆ¸' : 'æ–°å»ºä¼˜æƒ åˆ¸'}
      visible={visible}
      onOk={handleOk}
      onCancel={onCancel}
      width={600}
    >
      <Form
        getFormApi={(api) => setFormApi(api)}
        initValues={coupon}
      >
        <Form.Input
          field='code'
          label='ä¼˜æƒ åˆ¸ä»£ç '
          placeholder='è¾“å…¥ä¼˜æƒ åˆ¸ä»£ç '
          rules={[{ required: true, message: 'ä»£ç ä¸èƒ½ä¸ºç©º' }]}
        />

        <Form.InputNumber
          field='discount'
          label='æŠ˜æ‰£é¢åº¦'
          placeholder='è¾“å…¥æŠ˜æ‰£é¢åº¦'
          min={1}
          rules={[{ required: true, message: 'æŠ˜æ‰£é¢åº¦ä¸èƒ½ä¸ºç©º' }]}
        />

        <Form.InputNumber
          field='max_uses'
          label='æœ€å¤§ä½¿ç”¨æ¬¡æ•°'
          placeholder='-1 è¡¨ç¤ºæ— é™'
          min={-1}
          initValue={-1}
        />

        <Form.DatePicker
          field='expired_time'
          label='è¿‡æœŸæ—¶é—´'
          type='dateTime'
          placeholder='é€‰æ‹©è¿‡æœŸæ—¶é—´'
        />

        <Form.Select
          field='status'
          label='çŠ¶æ€'
          initValue={1}
        >
          <Select.Option value={1}>å¯ç”¨</Select.Option>
          <Select.Option value={2}>ç¦ç”¨</Select.Option>
        </Form.Select>
      </Form>
    </Modal>
  );
};

export default EditCouponModal;
```

**æ­¥éª¤ 5: æ·»åŠ è·¯ç”± (App.jsx)**

```javascript
import Coupon from './pages/Coupon';

// åœ¨ routes å¯¹è±¡ä¸­æ·»åŠ 
const routes = {
  // ... å…¶ä»–è·¯ç”±
  '/console/coupon': {
    element: <AdminRoute><Coupon /></AdminRoute>,
  },
};
```

**æ­¥éª¤ 6: æ·»åŠ ä¾§è¾¹æ èœå•é¡¹ (components/layout/SiderBar.jsx)**

```javascript
// åœ¨ç®¡ç†å‘˜èœå•ä¸­æ·»åŠ 
const adminMenuItems = [
  // ... å…¶ä»–èœå•
  {
    itemKey: '/console/coupon',
    text: t('sider.coupon'),
    icon: <IconTicket />,
  },
];
```

**æ­¥éª¤ 7: æ·»åŠ å›½é™…åŒ–æ–‡æ¡ˆ (i18n/locales/zh.json)**

```json
{
  "sider": {
    "coupon": "ä¼˜æƒ åˆ¸ç®¡ç†"
  }
}
```

### 5.3 çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

**ä½¿ç”¨ Context API ç®¡ç†å…¨å±€çŠ¶æ€**ï¼š

```javascript
// context/Coupon/index.jsx
import React, { createContext, useReducer } from 'react';
import reducer from './reducer';

const initialState = {
  coupons: [],
  selectedCoupon: null,
};

const CouponContext = createContext(initialState);

const CouponProvider = ({ children }) => {
  const [state, dispatch] = useReducer(reducer, initialState);

  return (
    <CouponContext.Provider value={[state, dispatch]}>
      {children}
    </CouponContext.Provider>
  );
};

export { CouponContext, CouponProvider };
```

```javascript
// context/Coupon/reducer.js
export default function reducer(state, action) {
  switch (action.type) {
    case 'setCoupons':
      return {
        ...state,
        coupons: action.payload,
      };
    case 'setSelectedCoupon':
      return {
        ...state,
        selectedCoupon: action.payload,
      };
    default:
      return state;
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```javascript
import { useContext } from 'react';
import { CouponContext } from '../../context/Coupon';

const MyCouponComponent = () => {
  const [couponState, couponDispatch] = useContext(CouponContext);

  // è®¾ç½®ä¼˜æƒ åˆ¸åˆ—è¡¨
  couponDispatch({
    type: 'setCoupons',
    payload: coupons
  });

  // è·å–ä¼˜æƒ åˆ¸åˆ—è¡¨
  const { coupons } = couponState;

  return (
    <div>
      {/* ç»„ä»¶å†…å®¹ */}
    </div>
  );
};
```

### 5.4 å›½é™…åŒ–å¼€å‘

**æ·»åŠ æ–°è¯­è¨€æ”¯æŒ**ï¼š

```javascript
// i18n/locales/es.json (è¥¿ç­ç‰™è¯­)
{
  "common": {
    "save": "Guardar",
    "cancel": "Cancelar",
    "delete": "Eliminar",
    "edit": "Editar"
  },
  "sider": {
    "dashboard": "Tablero",
    "coupon": "GestiÃ³n de cupones"
  }
}
```

```javascript
// i18n/i18n.js
import es from './locales/es.json';

i18n.use(initReactI18next).init({
  resources: {
    zh: { translation: zh },
    en: { translation: en },
    es: { translation: es }, // æ·»åŠ è¥¿ç­ç‰™è¯­
  },
  // ...
});
```

**ä½¿ç”¨ç¿»è¯‘**ï¼š

```javascript
import { useTranslation } from 'react-i18next';

const MyComponent = () => {
  const { t } = useTranslation();

  return (
    <div>
      <h1>{t('common.save')}</h1>
      <p>{t('sider.coupon')}</p>
    </div>
  );
};
```

---

## å…­ã€æ•°æ®åº“è®¾è®¡

### 6.1 æ ¸å¿ƒæ•°æ®è¡¨

**1. users (ç”¨æˆ·è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | INT | ä¸»é”® | PRIMARY KEY |
| username | VARCHAR(20) | ç”¨æˆ·å | UNIQUE INDEX |
| password | VARCHAR(255) | å¯†ç å“ˆå¸Œ | |
| display_name | VARCHAR(20) | æ˜¾ç¤ºåç§° | INDEX |
| email | VARCHAR(50) | é‚®ç®± | INDEX |
| role | INT | è§’è‰² (1-æ™®é€š, 10-ç®¡ç†å‘˜, 100-è¶…çº§ç®¡ç†å‘˜) | |
| status | INT | çŠ¶æ€ (1-å¯ç”¨, 2-ç¦ç”¨) | |
| quota | INT | å¯ç”¨é…é¢ | |
| used_quota | INT | å·²ç”¨é…é¢ | |
| group | VARCHAR(64) | ç”¨æˆ·åˆ†ç»„ | |
| github_id | VARCHAR(50) | GitHub ID | INDEX |
| discord_id | VARCHAR(50) | Discord ID | INDEX |
| oidc_id | VARCHAR(50) | OIDC ID | INDEX |
| access_token | CHAR(32) | ç®¡ç†ä»¤ç‰Œ | UNIQUE INDEX |
| aff_code | VARCHAR(32) | é‚€è¯·ç  | UNIQUE INDEX |
| inviter_id | INT | é‚€è¯·äºº ID | INDEX |
| setting | TEXT | ç”¨æˆ·è®¾ç½® (JSON) | |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | |
| deleted_at | TIMESTAMP | åˆ é™¤æ—¶é—´ | INDEX |

**2. tokens (API ä»¤ç‰Œè¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | INT | ä¸»é”® | PRIMARY KEY |
| user_id | INT | ç”¨æˆ· ID | INDEX |
| key | CHAR(48) | ä»¤ç‰Œå¯†é’¥ (sk-xxx) | UNIQUE INDEX |
| name | VARCHAR(255) | ä»¤ç‰Œåç§° | INDEX |
| status | INT | çŠ¶æ€ (1-å¯ç”¨, 2-ç¦ç”¨, 3-è€—å°½, 4-è¿‡æœŸ) | |
| remain_quota | INT | å‰©ä½™é…é¢ | |
| unlimited_quota | BOOLEAN | æ˜¯å¦æ— é™é…é¢ | |
| used_quota | INT | å·²ç”¨é…é¢ | |
| model_limits_enabled | BOOLEAN | æ˜¯å¦å¯ç”¨æ¨¡å‹é™åˆ¶ | |
| model_limits | VARCHAR(1024) | æ¨¡å‹é™åˆ¶åˆ—è¡¨ | |
| allow_ips | TEXT | å…è®¸çš„ IP åˆ—è¡¨ | |
| group | VARCHAR(255) | æ‰€å±åˆ†ç»„ | |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ | |
| accessed_time | BIGINT | æœ€åè®¿é—®æ—¶é—´ | |
| expired_time | BIGINT | è¿‡æœŸæ—¶é—´ (-1 æ°¸ä¸è¿‡æœŸ) | |
| deleted_at | TIMESTAMP | åˆ é™¤æ—¶é—´ | INDEX |

**3. channels (æ¸ é“è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | INT | ä¸»é”® | PRIMARY KEY |
| type | INT | æ¸ é“ç±»å‹ (1-OpenAI, 2-Claude...) | |
| name | VARCHAR(255) | æ¸ é“åç§° | INDEX |
| key | TEXT | API å¯†é’¥ (å¯å¤šä¸ª) | |
| base_url | VARCHAR(255) | åŸºç¡€ URL | |
| models | TEXT | æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ | |
| model_mapping | TEXT | æ¨¡å‹æ˜ å°„ (JSON) | |
| status | INT | çŠ¶æ€ (1-å¯ç”¨, 2-ç¦ç”¨, 3-è‡ªåŠ¨ç¦ç”¨) | |
| weight | INT | æƒé‡ (ç”¨äºè´Ÿè½½å‡è¡¡) | |
| priority | BIGINT | ä¼˜å…ˆçº§ | |
| test_model | VARCHAR(255) | æµ‹è¯•æ¨¡å‹ | |
| test_time | BIGINT | æœ€åæµ‹è¯•æ—¶é—´ | |
| response_time | INT | å“åº”æ—¶é—´ (ms) | |
| balance | FLOAT | ä½™é¢ (USD) | |
| balance_updated_time | BIGINT | ä½™é¢æ›´æ–°æ—¶é—´ | |
| used_quota | BIGINT | å·²ç”¨é…é¢ | |
| group | VARCHAR(64) | æ‰€å±åˆ†ç»„ | |
| tag | VARCHAR(255) | æ ‡ç­¾ | INDEX |
| auto_ban | INT | æ˜¯å¦è‡ªåŠ¨ç¦ç”¨ (0-å¦, 1-æ˜¯) | |
| param_override | TEXT | å‚æ•°è¦†ç›– (JSON) | |
| header_override | TEXT | è¯·æ±‚å¤´è¦†ç›– (JSON) | |
| setting | TEXT | æ¸ é“è®¾ç½® (JSON) | |
| channel_info | JSON | å¤šå¯†é’¥ä¿¡æ¯ | |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ | |
| deleted_at | TIMESTAMP | åˆ é™¤æ—¶é—´ | INDEX |

**4. logs (æ—¥å¿—è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|------|------|------|------|
| id | INT | ä¸»é”® | PRIMARY KEY, INDEX(created_at, id) |
| user_id | INT | ç”¨æˆ· ID | INDEX |
| token_id | INT | ä»¤ç‰Œ ID | INDEX |
| channel_id | INT | æ¸ é“ ID | INDEX |
| username | VARCHAR(255) | ç”¨æˆ·å | INDEX |
| token_name | VARCHAR(255) | ä»¤ç‰Œåç§° | INDEX |
| model_name | VARCHAR(255) | æ¨¡å‹åç§° | INDEX(username, model_name) |
| type | INT | æ—¥å¿—ç±»å‹ (1-å……å€¼, 2-æ¶ˆè´¹, 3-ç®¡ç†, 4-ç³»ç»Ÿ, 5-é”™è¯¯) | INDEX(created_at, type) |
| quota | INT | æ¶ˆè´¹é…é¢ | |
| prompt_tokens | INT | æç¤ºè¯ token æ•° | |
| completion_tokens | INT | å®Œæˆ token æ•° | |
| use_time | INT | ä½¿ç”¨æ—¶é—´ (ms) | |
| is_stream | BOOLEAN | æ˜¯å¦æµå¼ | |
| group | VARCHAR(64) | åˆ†ç»„ | INDEX |
| ip | VARCHAR(50) | è¯·æ±‚ IP | INDEX |
| content | TEXT | æ—¥å¿—å†…å®¹ | |
| other | TEXT | å…¶ä»–ä¿¡æ¯ (JSON) | |
| created_at | BIGINT | åˆ›å»ºæ—¶é—´ | INDEX |

**5. redemptions (å…‘æ¢ç è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| name | VARCHAR(255) | å…‘æ¢ç åç§° |
| key | VARCHAR(32) | å…‘æ¢ç  (å”¯ä¸€) |
| quota | INT | é¢åº¦ |
| count | INT | å¯å…‘æ¢æ¬¡æ•° (-1 æ— é™) |
| used | INT | å·²å…‘æ¢æ¬¡æ•° |
| status | INT | çŠ¶æ€ |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ |
| deleted_at | TIMESTAMP | åˆ é™¤æ—¶é—´ |

**6. topups (å……å€¼è®°å½•è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| user_id | INT | ç”¨æˆ· ID |
| amount | INT | å……å€¼é‡‘é¢ |
| quota | INT | è·å¾—é…é¢ |
| trade_no | VARCHAR(255) | äº¤æ˜“å· |
| status | INT | çŠ¶æ€ (1-å¾…æ”¯ä»˜, 2-å·²æ”¯ä»˜) |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ |
| updated_time | BIGINT | æ›´æ–°æ—¶é—´ |

**7. pricing (å®šä»·è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| model_name | VARCHAR(255) | æ¨¡å‹åç§° |
| input_price | FLOAT | è¾“å…¥ä»·æ ¼ (USD/M tokens) |
| output_price | FLOAT | è¾“å‡ºä»·æ ¼ (USD/M tokens) |
| updated_time | BIGINT | æ›´æ–°æ—¶é—´ |

**8. twofa (åŒå› ç´ è®¤è¯è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | INT | ç”¨æˆ· ID (ä¸»é”®) |
| secret | VARCHAR(255) | TOTP å¯†é’¥ |
| backup_codes | TEXT | å¤‡ç”¨ç  (JSON) |
| enabled | BOOLEAN | æ˜¯å¦å¯ç”¨ |

**9. passkey (Passkey è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| user_id | INT | ç”¨æˆ· ID |
| name | VARCHAR(255) | Passkey åç§° |
| credential_id | TEXT | å‡­è¯ ID |
| public_key | TEXT | å…¬é’¥ |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ |

**10. tasks (å¼‚æ­¥ä»»åŠ¡è¡¨)**

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INT | ä¸»é”® |
| user_id | INT | ç”¨æˆ· ID |
| channel_id | INT | æ¸ é“ ID |
| task_id | VARCHAR(255) | ä»»åŠ¡ ID |
| type | INT | ä»»åŠ¡ç±»å‹ (1-Midjourney, 2-è§†é¢‘) |
| status | INT | çŠ¶æ€ (1-å¾…å¤„ç†, 2-å¤„ç†ä¸­, 3-å®Œæˆ, 4-å¤±è´¥) |
| progress | INT | è¿›åº¦ (0-100) |
| result | TEXT | ç»“æœ (JSON) |
| created_time | BIGINT | åˆ›å»ºæ—¶é—´ |
| updated_time | BIGINT | æ›´æ–°æ—¶é—´ |

### 6.2 è¡¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚       â”‚   tokens    â”‚
â”‚             â”‚â—„â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚ id          â”‚ 1   * â”‚ user_id     â”‚
â”‚ username    â”‚       â”‚ key         â”‚
â”‚ quota       â”‚       â”‚ remain_quotaâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”‚
      â”‚ 1                     â”‚ 1
      â”‚                       â”‚
      â”‚ *                     â”‚ *
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   logs      â”‚       â”‚   channels     â”‚
â”‚             â”‚       â”‚                â”‚
â”‚ user_id     â”‚       â”‚ id             â”‚
â”‚ token_id    â”‚       â”‚ type           â”‚
â”‚ channel_id  â”œâ”€â”€â”€â”€â”€â”€â–ºâ”‚ name           â”‚
â”‚ quota       â”‚ *   1 â”‚ models         â”‚
â”‚ created_at  â”‚       â”‚ status         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ•°æ®åº“è¿ç§»

**è‡ªåŠ¨è¿ç§»**:

é¡¹ç›®ä½¿ç”¨ GORM çš„ `AutoMigrate` åŠŸèƒ½ï¼Œé¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„ã€‚

```go
// model/main.go
func InitDB() error {
    // ... æ•°æ®åº“è¿æ¥

    // è‡ªåŠ¨è¿ç§»
    err := DB.AutoMigrate(
        &User{},
        &Token{},
        &Channel{},
        &Log{},
        &Redemption{},
        &TopUp{},
        &Pricing{},
        &TwoFA{},
        &Passkey{},
        &Task{},
        // ... æ›´å¤šæ¨¡å‹
    )

    if err != nil {
        return err
    }

    return nil
}
```

**æ‰‹åŠ¨è¿ç§»**:

å¦‚æœéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ SQL è¿ç§»ï¼Œå¯ä»¥åœ¨ `docs/migrations/` ç›®å½•ä¸‹åˆ›å»ºè¿ç§»æ–‡ä»¶ï¼š

```sql
-- docs/migrations/001_add_coupon_table.sql
CREATE TABLE IF NOT EXISTS coupons (
    id SERIAL PRIMARY KEY,
    code VARCHAR(32) UNIQUE NOT NULL,
    discount INT NOT NULL,
    max_uses INT DEFAULT -1,
    used_count INT DEFAULT 0,
    expired_time BIGINT DEFAULT -1,
    status INT DEFAULT 1,
    created_time BIGINT NOT NULL,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_coupon_code ON coupons(code);
CREATE INDEX idx_coupon_status ON coupons(status);
```

---

## ä¸ƒã€æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 7.1 ç”¨æˆ·è®¤è¯æµç¨‹

```
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
   â†“
2. POST /api/user/login
   â†“
3. Controller: user.go#Login()
   - éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
   - æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
   â†“
4. ç”Ÿæˆ Session
   - è®¾ç½® Session Cookie
   â†“
5. è¿”å›ç”¨æˆ·ä¿¡æ¯
   {
     "success": true,
     "data": {
       "id": 1,
       "username": "user1",
       "role": 1,
       "quota": 100000,
       ...
     }
   }
   â†“
6. å‰ç«¯ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° Context å’Œ localStorage
   â†“
7. è·³è½¬åˆ°æ§åˆ¶å°
```

### 7.2 AI è¯·æ±‚ä¸­ç»§æµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€ OpenAI æ ¼å¼è¯·æ±‚
   POST /v1/chat/completions
   Authorization: Bearer sk-xxx
   {
     "model": "gpt-4",
     "messages": [...]
   }
   â†“
2. Middleware é“¾å¤„ç†
   - Auth: éªŒè¯ Token
   - Rate-Limit: æ£€æŸ¥é€Ÿç‡
   - Distributor: é€‰æ‹©æ¸ é“
   â†“
3. æ¸ é“é€‰æ‹©é€»è¾‘ (service/channel_select.go)
   - æ ¹æ®æ¨¡å‹ã€åˆ†ç»„ã€ä¼˜å…ˆçº§ç­›é€‰å¯ç”¨æ¸ é“
   - æŒ‰æƒé‡éšæœºé€‰æ‹©ä¸€ä¸ªæ¸ é“
   - å¦‚æœæ˜¯å¤šå¯†é’¥æ¸ é“ï¼Œé€‰æ‹©å¯ç”¨å¯†é’¥
   â†“
4. é¢„æ‰£è´¹ (service/quota.go#PreConsumeQuota)
   - æ£€æŸ¥ç”¨æˆ·å’Œ Token é…é¢
   - æ‰£é™¤é¢„ä¼°é…é¢
   â†“
5. Controller: relay.go#Relay()
   - æ ¹æ®è¯·æ±‚ç±»å‹åˆ†å‘ (text/image/audio/embedding)
   â†“
6. Relay Handler (relay/text_handler.go)
   - è·å–å¯¹åº”å‚å•†çš„ Adaptor
   â†“
7. Adaptor å¤„ç†
   - ConvertRequest: è½¬æ¢ä¸ºå‚å•†æ ¼å¼
   - SetupRequestHeader: è®¾ç½®è®¤è¯å¤´
   - DoRequest: å‘é€ HTTP è¯·æ±‚åˆ°ä¸Šæ¸¸
   â†“
8. ä¸Šæ¸¸ AI æœåŠ¡å•†è¿”å›å“åº”
   â†“
9. Adaptor å¤„ç†å“åº”
   - è§£æå“åº”
   - è½¬æ¢ä¸º OpenAI æ ¼å¼
   â†“
10. åæ‰£è´¹ (service/quota.go#PostConsumeQuota)
    - æ ¹æ®å®é™…æ¶ˆè€—è®¡ç®—é…é¢
    - è°ƒæ•´ç”¨æˆ·å’Œ Token é…é¢
    - è®°å½•æ¶ˆè´¹æ—¥å¿—
    â†“
11. è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
    {
      "id": "chatcmpl-xxx",
      "object": "chat.completion",
      "created": 1234567890,
      "model": "gpt-4",
      "choices": [...],
      "usage": {
        "prompt_tokens": 10,
        "completion_tokens": 20,
        "total_tokens": 30
      }
    }
```

### 7.3 æ¸ é“è‡ªåŠ¨ç¦ç”¨æµç¨‹

```
1. è¯·æ±‚å¤±è´¥æˆ–è¿”å›é”™è¯¯
   â†“
2. service/channel.go#ShouldDisableChannel()
   åˆ¤æ–­æ˜¯å¦åº”è¯¥è‡ªåŠ¨ç¦ç”¨:
   - æ£€æŸ¥é”™è¯¯ç±»å‹ (401, 403, ä½™é¢ä¸è¶³ç­‰)
   - æ£€æŸ¥é”™è¯¯æ¶ˆæ¯å…³é”®è¯
   â†“
3. å¦‚æœéœ€è¦ç¦ç”¨
   â†“
4. service/channel.go#DisableChannel()
   - æ›´æ–°æ¸ é“çŠ¶æ€ä¸º"è‡ªåŠ¨ç¦ç”¨"
   - è®°å½•ç¦ç”¨åŸå› 
   - è®°å½•ç¦ç”¨æ—¶é—´
   â†“
5. å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜
   - é‚®ä»¶é€šçŸ¥
   - Webhook é€šçŸ¥
   â†“
6. è®°å½•æ—¥å¿—
```

### 7.4 å¤šå¯†é’¥è½®è¯¢æµç¨‹

```
1. æ¸ é“é…ç½®å¤šä¸ª API å¯†é’¥
   keys: ["key1", "key2", "key3"]
   â†“
2. è®¾ç½®å¤šå¯†é’¥æ¨¡å¼
   - Polling (è½®è¯¢)
   - Random (éšæœº)
   â†“
3. é¦–æ¬¡ä½¿ç”¨
   MultiKeyPollingIndex = 0
   â†“
4. è·å–ä¸‹ä¸€ä¸ªå¯ç”¨å¯†é’¥
   model/channel.go#GetNextEnabledKey()
   â†“
5. æ£€æŸ¥å¯†é’¥çŠ¶æ€
   MultiKeyStatusList[index] == Enabled?
   â†“
6. å¦‚æœè½®è¯¢æ¨¡å¼
   - è¿”å› keys[index]
   - index = (index + 1) % len(keys)
   â†“
   å¦‚æœéšæœºæ¨¡å¼
   - éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„å¯†é’¥
   â†“
7. ä½¿ç”¨é€‰ä¸­çš„å¯†é’¥å‘é€è¯·æ±‚
   â†“
8. å¦‚æœè¯·æ±‚å¤±è´¥ä¸”åº”è¯¥ç¦ç”¨å¯†é’¥
   - MultiKeyStatusList[index] = Disabled
   - è®°å½•ç¦ç”¨åŸå› å’Œæ—¶é—´
   â†“
9. ä¸‹æ¬¡è¯·æ±‚æ—¶è·³è¿‡ç¦ç”¨çš„å¯†é’¥
```

### 7.5 é…é¢è®¡è´¹æµç¨‹

**é¢„æ‰£è´¹ (PreConsumeQuota)**:

```
1. æ¥æ”¶åˆ°è¯·æ±‚
   â†“
2. ä¼°ç®—æœ¬æ¬¡è¯·æ±‚çš„é…é¢æ¶ˆè€—
   - æ–‡æœ¬: æ ¹æ® prompt tokens ä¼°ç®—
   - å›¾åƒ: å›ºå®šé…é¢
   - éŸ³é¢‘: å›ºå®šé…é¢æˆ–æ ¹æ®æ—¶é•¿ä¼°ç®—
   â†“
3. æ£€æŸ¥ç”¨æˆ·é…é¢
   user.Quota >= estimatedQuota?
   â†“
4. æ£€æŸ¥ Token é…é¢ (å¦‚æœä¸æ˜¯æ— é™é…é¢)
   token.RemainQuota >= estimatedQuota?
   â†“
5. æ‰£é™¤é…é¢
   - user.Quota -= estimatedQuota
   - token.RemainQuota -= estimatedQuota
   â†“
6. ç»§ç»­å¤„ç†è¯·æ±‚
```

**åæ‰£è´¹ (PostConsumeQuota)**:

```
1. è¯·æ±‚å®Œæˆï¼Œè·å–å®é™…æ¶ˆè€—
   - prompt_tokens
   - completion_tokens
   - cached_tokens (å¦‚æœæ”¯æŒ)
   â†“
2. è®¡ç®—å®é™…é…é¢
   å¦‚æœæŒ‰å€ç‡è®¡è´¹:
     quota = (prompt_tokens + completion_tokens * completionRatio)
             * modelRatio * groupRatio

   å¦‚æœæŒ‰ä»·æ ¼è®¡è´¹:
     quota = (prompt_tokens * inputPrice +
              completion_tokens * outputPrice)
             * quotaPerUnit * groupRatio

   å¦‚æœæœ‰ç¼“å­˜ä¼˜æƒ  (Claude):
     cachedQuota = cached_tokens * cacheRatio * modelRatio * groupRatio
     quota -= cachedQuota
   â†“
3. è®¡ç®—é…é¢å·®å¼‚
   diff = actualQuota - estimatedQuota
   â†“
4. è°ƒæ•´é…é¢
   å¦‚æœ diff > 0 (å®é™…æ¶ˆè€—æ›´å¤š):
     - user.Quota -= diff
     - token.RemainQuota -= diff

   å¦‚æœ diff < 0 (å®é™…æ¶ˆè€—æ›´å°‘):
     - user.Quota += abs(diff)
     - token.RemainQuota += abs(diff)
   â†“
5. æ›´æ–°æ•°æ®åº“
   - æ›´æ–°ç”¨æˆ·å’Œ Token çš„é…é¢
   â†“
6. è®°å½•æ¶ˆè´¹æ—¥å¿—
   log := Log{
     UserId: userId,
     TokenId: tokenId,
     ChannelId: channelId,
     ModelName: model,
     Quota: actualQuota,
     PromptTokens: promptTokens,
     CompletionTokens: completionTokens,
     ...
   }
   â†“
7. æ£€æŸ¥é…é¢é¢„è­¦
   å¦‚æœ user.Quota < warningThreshold:
     - å‘é€é€šçŸ¥ç»™ç”¨æˆ·

   å¦‚æœ token.RemainQuota <= 0:
     - æ›´æ–° Token çŠ¶æ€ä¸º"è€—å°½"
```

---

## å…«ã€æ‰©å±•å¼€å‘æŒ‡å—

### 8.1 æ·»åŠ æ–°çš„è®¤è¯æ–¹å¼

**åœºæ™¯**: æ·»åŠ å¾®ä¿¡ç™»å½•æ”¯æŒã€‚

**æ­¥éª¤ 1: æ·»åŠ æ•°æ®åº“å­—æ®µ**

```go
// model/user.go
type User struct {
    // ... å…¶ä»–å­—æ®µ
    WeChatId string `json:"wechat_id" gorm:"column:wechat_id;index"`
}
```

**æ­¥éª¤ 2: åˆ›å»º OAuth æ§åˆ¶å™¨ (controller/wechat.go)**

```go
package controller

import (
    "net/http"
    "github.com/QuantumNous/new-api/common"
    "github.com/QuantumNous/new-api/model"
    "github.com/gin-gonic/gin"
)

// WeChat OAuth å›è°ƒ
func WeChatOAuth(c *gin.Context) {
    code := c.Query("code")
    state := c.Query("state")

    // éªŒè¯ state
    if !verifyState(state) {
        c.JSON(http.StatusOK, common.ApiError("invalid state"))
        return
    }

    // ä½¿ç”¨ code æ¢å– access_token
    accessToken, openId, err := getWeChatAccessToken(code)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to get access token"))
        return
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    userInfo, err := getWeChatUserInfo(accessToken, openId)
    if err != nil {
        c.JSON(http.StatusOK, common.ApiError("failed to get user info"))
        return
    }

    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    user, err := model.GetUserByWeChatId(openId)
    if err != nil {
        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
        user = &model.User{
            Username: "wechat_" + openId[:8],
            DisplayName: userInfo.Nickname,
            WeChatId: openId,
            Role: common.RoleCommonUser,
            Status: common.UserStatusEnabled,
        }
        err = user.Insert()
        if err != nil {
            c.JSON(http.StatusOK, common.ApiError("failed to create user"))
            return
        }
    }

    // è®¾ç½® Session
    setupLogin(c, user)

    // é‡å®šå‘åˆ°æ§åˆ¶å°
    c.Redirect(http.StatusFound, "/console")
}

func getWeChatAccessToken(code string) (accessToken string, openId string, err error) {
    // è°ƒç”¨å¾®ä¿¡ API è·å– access_token
    // https://api.weixin.qq.com/sns/oauth2/access_token?...
    // è¿”å› access_token å’Œ openid
    return "", "", nil
}

func getWeChatUserInfo(accessToken string, openId string) (*WeChatUserInfo, error) {
    // è°ƒç”¨å¾®ä¿¡ API è·å–ç”¨æˆ·ä¿¡æ¯
    // https://api.weixin.qq.com/sns/userinfo?...
    return nil, nil
}

type WeChatUserInfo struct {
    OpenId   string `json:"openid"`
    Nickname string `json:"nickname"`
    Avatar   string `json:"headimgurl"`
}
```

**æ­¥éª¤ 3: æ·»åŠ è·¯ç”± (router/api-router.go)**

```go
func SetApiRouter(router *gin.Engine) {
    // ... å…¶ä»–è·¯ç”±

    // å¾®ä¿¡ OAuth è·¯ç”±
    apiRouter.GET("/oauth/wechat", controller.WeChatOAuth)
}
```

**æ­¥éª¤ 4: å‰ç«¯æ·»åŠ ç™»å½•æŒ‰é’® (components/auth/LoginForm.jsx)**

```javascript
const handleWeChatLogin = () => {
  const appId = 'YOUR_WECHAT_APP_ID';
  const redirectUri = encodeURIComponent('http://localhost:3000/api/oauth/wechat');
  const state = generateRandomState();

  // ä¿å­˜ state åˆ° localStorage
  localStorage.setItem('oauth_state', state);

  // é‡å®šå‘åˆ°å¾®ä¿¡æˆæƒé¡µé¢
  window.location.href = `https://open.weixin.qq.com/connect/qrconnect?appid=${appId}&redirect_uri=${redirectUri}&response_type=code&scope=snsapi_login&state=${state}#wechat_redirect`;
};

return (
  <div>
    {/* ... å…¶ä»–ç™»å½•æ–¹å¼ */}

    <Button
      icon={<WeChatIcon />}
      onClick={handleWeChatLogin}
    >
      ä½¿ç”¨å¾®ä¿¡ç™»å½•
    </Button>
  </div>
);
```

### 8.2 æ·»åŠ æ–°çš„è®¡è´¹æ¨¡å¼

**åœºæ™¯**: æ·»åŠ "åŒ…æœˆè®¢é˜…"è®¡è´¹æ¨¡å¼ã€‚

**æ­¥éª¤ 1: æ·»åŠ æ•°æ®åº“è¡¨**

```sql
CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    plan_id INT NOT NULL,
    status INT DEFAULT 1, -- 1-active, 2-expired, 3-canceled
    quota_per_month INT NOT NULL,
    price FLOAT NOT NULL,
    start_time BIGINT NOT NULL,
    end_time BIGINT NOT NULL,
    created_time BIGINT NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE subscription_plans (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    quota_per_month INT NOT NULL,
    price FLOAT NOT NULL,
    models TEXT, -- JSON array of allowed models
    description TEXT,
    status INT DEFAULT 1
);
```

**æ­¥éª¤ 2: åˆ›å»ºæ¨¡å‹ (model/subscription.go)**

```go
package model

type Subscription struct {
    Id            int    `json:"id"`
    UserId        int    `json:"user_id" gorm:"index"`
    PlanId        int    `json:"plan_id"`
    Status        int    `json:"status" gorm:"default:1"`
    QuotaPerMonth int    `json:"quota_per_month"`
    Price         float64 `json:"price"`
    StartTime     int64  `json:"start_time" gorm:"bigint"`
    EndTime       int64  `json:"end_time" gorm:"bigint"`
    CreatedTime   int64  `json:"created_time" gorm:"bigint"`
}

type SubscriptionPlan struct {
    Id            int     `json:"id"`
    Name          string  `json:"name"`
    QuotaPerMonth int     `json:"quota_per_month"`
    Price         float64 `json:"price"`
    Models        string  `json:"models"`
    Description   string  `json:"description"`
    Status        int     `json:"status" gorm:"default:1"`
}

// è·å–ç”¨æˆ·çš„æ´»è·ƒè®¢é˜…
func GetActiveSubscription(userId int) (*Subscription, error) {
    var sub Subscription
    now := common.GetTimestamp()
    err := DB.Where("user_id = ? AND status = ? AND start_time <= ? AND end_time >= ?",
        userId, 1, now, now).First(&sub).Error
    return &sub, err
}

// åˆ›å»ºè®¢é˜…
func (sub *Subscription) Insert() error {
    return DB.Create(sub).Error
}

// æ›´æ–°è®¢é˜…
func (sub *Subscription) Update() error {
    return DB.Save(sub).Error
}
```

**æ­¥éª¤ 3: åˆ›å»ºæœåŠ¡ (service/subscription.go)**

```go
package service

import (
    "errors"
    "time"
    "github.com/QuantumNous/new-api/model"
    "github.com/QuantumNous/new-api/common"
)

// è®¢é˜…å¥—é¤
func Subscribe(userId int, planId int) error {
    // è·å–å¥—é¤ä¿¡æ¯
    plan, err := model.GetSubscriptionPlanById(planId)
    if err != nil {
        return errors.New("å¥—é¤ä¸å­˜åœ¨")
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰æ´»è·ƒè®¢é˜…
    existingSub, _ := model.GetActiveSubscription(userId)
    if existingSub != nil {
        return errors.New("æ‚¨å·²æœ‰æ´»è·ƒè®¢é˜…")
    }

    // åˆ›å»ºè®¢é˜…
    now := time.Now().Unix()
    endTime := time.Now().AddDate(0, 1, 0).Unix() // ä¸€ä¸ªæœˆå

    sub := &model.Subscription{
        UserId:        userId,
        PlanId:        planId,
        Status:        1,
        QuotaPerMonth: plan.QuotaPerMonth,
        Price:         plan.Price,
        StartTime:     now,
        EndTime:       endTime,
        CreatedTime:   now,
    }

    err = sub.Insert()
    if err != nil {
        return errors.New("åˆ›å»ºè®¢é˜…å¤±è´¥")
    }

    // å¢åŠ ç”¨æˆ·é…é¢
    err = model.IncreaseUserQuota(userId, plan.QuotaPerMonth)
    if err != nil {
        return errors.New("å¢åŠ é…é¢å¤±è´¥")
    }

    // è®°å½•æ—¥å¿—
    model.RecordLog(userId, model.LogTypeTopup,
        fmt.Sprintf("è®¢é˜…å¥—é¤ %sï¼Œè·å¾— %d é…é¢", plan.Name, plan.QuotaPerMonth))

    return nil
}

// ç»­è´¹è®¢é˜…
func RenewSubscription(userId int) error {
    sub, err := model.GetActiveSubscription(userId)
    if err != nil {
        return errors.New("æ²¡æœ‰æ´»è·ƒè®¢é˜…")
    }

    // å»¶é•¿è®¢é˜…æ—¶é—´
    sub.EndTime = time.Unix(sub.EndTime, 0).AddDate(0, 1, 0).Unix()
    err = sub.Update()
    if err != nil {
        return errors.New("ç»­è´¹å¤±è´¥")
    }

    // å¢åŠ ç”¨æˆ·é…é¢
    err = model.IncreaseUserQuota(userId, sub.QuotaPerMonth)
    if err != nil {
        return errors.New("å¢åŠ é…é¢å¤±è´¥")
    }

    return nil
}

// å–æ¶ˆè®¢é˜…
func CancelSubscription(userId int) error {
    sub, err := model.GetActiveSubscription(userId)
    if err != nil {
        return errors.New("æ²¡æœ‰æ´»è·ƒè®¢é˜…")
    }

    sub.Status = 3 // canceled
    err = sub.Update()
    if err != nil {
        return errors.New("å–æ¶ˆå¤±è´¥")
    }

    return nil
}

// æ£€æŸ¥å¹¶æ›´æ–°è¿‡æœŸè®¢é˜…
func CheckExpiredSubscriptions() {
    // å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©æ£€æŸ¥ä¸€æ¬¡
    subs, _ := model.GetAllSubscriptions()
    now := common.GetTimestamp()

    for _, sub := range subs {
        if sub.Status == 1 && sub.EndTime < now {
            sub.Status = 2 // expired
            sub.Update()
        }
    }
}
```

**æ­¥éª¤ 4: æ·»åŠ å®šæ—¶ä»»åŠ¡ (main.go)**

```go
func main() {
    // ... åˆå§‹åŒ–

    // å¯åŠ¨è®¢é˜…æ£€æŸ¥å®šæ—¶ä»»åŠ¡
    go func() {
        ticker := time.NewTicker(24 * time.Hour)
        defer ticker.Stop()

        for range ticker.C {
            service.CheckExpiredSubscriptions()
        }
    }()

    // ... å¯åŠ¨æœåŠ¡å™¨
}
```

### 8.3 æ·»åŠ æ–°çš„é€šçŸ¥æ¸ é“

**åœºæ™¯**: æ·»åŠ ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ”¯æŒã€‚

```go
// service/notify_wework.go
package service

import (
    "bytes"
    "encoding/json"
    "net/http"
    "os"
)

type WeWorkMessage struct {
    MsgType string      `json:"msgtype"`
    Text    WeWorkText  `json:"text"`
}

type WeWorkText struct {
    Content string `json:"content"`
}

// å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
func SendWeWorkNotification(title string, content string) error {
    webhookUrl := os.Getenv("WEWORK_WEBHOOK_URL")
    if webhookUrl == "" {
        return nil // æœªé…ç½®ï¼Œè·³è¿‡
    }

    message := WeWorkMessage{
        MsgType: "text",
        Text: WeWorkText{
            Content: fmt.Sprintf("%s\n\n%s", title, content),
        },
    }

    body, _ := json.Marshal(message)

    resp, err := http.Post(webhookUrl, "application/json", bytes.NewReader(body))
    if err != nil {
        return err
    }
    defer resp.Body.Close()

    if resp.StatusCode != 200 {
        return fmt.Errorf("failed to send notification: %d", resp.StatusCode)
    }

    return nil
}

// åœ¨ channel.go ä¸­è°ƒç”¨
func DisableChannel(channelId int, reason string) error {
    // ... ç¦ç”¨æ¸ é“é€»è¾‘

    // å‘é€é€šçŸ¥
    SendWeWorkNotification(
        "æ¸ é“è‡ªåŠ¨ç¦ç”¨é€šçŸ¥",
        fmt.Sprintf("æ¸ é“ ID: %d\nåŸå› : %s", channelId, reason),
    )

    // ...
}
```

---

## ä¹ã€éƒ¨ç½²ä¸è¿ç»´

### 9.1 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**Docker Compose éƒ¨ç½² (æ¨è)**:

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: newapi
      POSTGRES_USER: newapi
      POSTGRES_PASSWORD: your_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  new-api:
    image: calciumion/new-api:latest
    ports:
      - "3000:3000"
    environment:
      SQL_DSN: postgres://newapi:your_password@postgres:5432/newapi?sslmode=disable
      REDIS_CONN_STRING: redis://redis:6379
      SESSION_SECRET: your_session_secret
      CRYPTO_SECRET: your_crypto_secret
      TZ: Asia/Shanghai
    depends_on:
      - postgres
      - redis
    volumes:
      - ./data:/data
    restart: always

volumes:
  postgres_data:
  redis_data:
```

å¯åŠ¨æœåŠ¡:

```bash
docker-compose up -d
```

**Kubernetes éƒ¨ç½²**:

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: new-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: new-api
  template:
    metadata:
      labels:
        app: new-api
    spec:
      containers:
      - name: new-api
        image: calciumion/new-api:latest
        ports:
        - containerPort: 3000
        env:
        - name: SQL_DSN
          valueFrom:
            secretKeyRef:
              name: new-api-secrets
              key: sql-dsn
        - name: REDIS_CONN_STRING
          valueFrom:
            secretKeyRef:
              name: new-api-secrets
              key: redis-conn
        - name: SESSION_SECRET
          valueFrom:
            secretKeyRef:
              name: new-api-secrets
              key: session-secret
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
---
apiVersion: v1
kind: Service
metadata:
  name: new-api
spec:
  selector:
    app: new-api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: LoadBalancer
```

### 9.2 æ€§èƒ½ä¼˜åŒ–

**1. æ•°æ®åº“ä¼˜åŒ–**:

```sql
-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_logs_user_created ON logs(user_id, created_at);
CREATE INDEX idx_logs_token_created ON logs(token_id, created_at);
CREATE INDEX idx_logs_channel_created ON logs(channel_id, created_at);

-- å®šæœŸæ¸…ç†æ—§æ—¥å¿—
DELETE FROM logs WHERE created_at < EXTRACT(EPOCH FROM NOW() - INTERVAL '90 days');

-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM logs WHERE user_id = 1 ORDER BY created_at DESC LIMIT 100;
```

**2. Redis ç¼“å­˜ä¼˜åŒ–**:

```go
// å¯ç”¨ Redis ç¼“å­˜
REDIS_CONN_STRING=redis://localhost:6379

// å¯ç”¨å†…å­˜ç¼“å­˜
MEMORY_CACHE_ENABLED=true

// è®¾ç½®åŒæ­¥é¢‘ç‡ (ç§’)
SYNC_FREQUENCY=60
```

**3. å¹¶å‘ä¼˜åŒ–**:

```bash
# å¢åŠ  Gin çš„å·¥ä½œåç¨‹æ•°
export GOMAXPROCS=8

# å¯ç”¨æ‰¹é‡æ›´æ–°
export BATCH_UPDATE_ENABLED=true
export BATCH_UPDATE_INTERVAL=10
```

**4. è¿æ¥æ± ä¼˜åŒ–**:

```go
// model/main.go
func InitDB() error {
    // ...

    // è®¾ç½®è¿æ¥æ± 
    sqlDB, _ := DB.DB()
    sqlDB.SetMaxIdleConns(10)
    sqlDB.SetMaxOpenConns(100)
    sqlDB.SetConnMaxLifetime(time.Hour)

    return nil
}
```

### 9.3 ç›‘æ§ä¸æ—¥å¿—

**1. å¯ç”¨ Prometheus ç›‘æ§**:

```bash
# å¯ç”¨ pprof
export ENABLE_PPROF=true
```

è®¿é—®ç›‘æ§ç«¯ç‚¹:
- CPU Profile: http://localhost:8005/debug/pprof/profile
- Heap Profile: http://localhost:8005/debug/pprof/heap
- Goroutine: http://localhost:8005/debug/pprof/goroutine

**2. é›†æˆ Uptime Kuma**:

åœ¨ç®¡ç†åå°é…ç½® Uptime Kuma:

```
è®¾ç½® â†’ Dashboard â†’ Uptime Kuma
- å¯ç”¨: æ˜¯
- URL: https://uptime.example.com
- ç›‘æ§åˆ—è¡¨: [...]
```

**3. æ—¥å¿—ç®¡ç†**:

```bash
# å¯ç”¨é”™è¯¯æ—¥å¿—
export ERROR_LOG_ENABLED=true

# å¯ç”¨æ¶ˆè´¹æ—¥å¿—
export LOG_CONSUME_ENABLED=true

# æ—¥å¿—æ–‡ä»¶ä½ç½®
tail -f logs/error.log
tail -f logs/access.log
```

### 9.4 å¤‡ä»½ä¸æ¢å¤

**æ•°æ®åº“å¤‡ä»½**:

```bash
# PostgreSQL
pg_dump -U newapi -h localhost newapi > backup_$(date +%Y%m%d).sql

# MySQL
mysqldump -u newapi -p newapi > backup_$(date +%Y%m%d).sql

# SQLite
cp data/new-api.db backup_$(date +%Y%m%d).db
```

**æ•°æ®åº“æ¢å¤**:

```bash
# PostgreSQL
psql -U newapi -h localhost newapi < backup_20250129.sql

# MySQL
mysql -u newapi -p newapi < backup_20250129.sql

# SQLite
cp backup_20250129.db data/new-api.db
```

**è‡ªåŠ¨å¤‡ä»½è„šæœ¬**:

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d)

# å¤‡ä»½æ•°æ®åº“
pg_dump -U newapi -h localhost newapi > $BACKUP_DIR/db_$DATE.sql

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp .env $BACKUP_DIR/env_$DATE.txt

# å‹ç¼©
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz $BACKUP_DIR/db_$DATE.sql $BACKUP_DIR/env_$DATE.txt

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +30 -delete

echo "Backup completed: backup_$DATE.tar.gz"
```

å®šæ—¶ä»»åŠ¡:

```bash
# æ¯å¤©å‡Œæ™¨ 3 ç‚¹å¤‡ä»½
0 3 * * * /path/to/backup.sh
```

---

## åã€å¸¸è§é—®é¢˜ä¸æœ€ä½³å®è·µ

### 10.1 å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼Ÿ**

A: ç™»å½•åè®¿é—®"ä¸ªäººè®¾ç½®" â†’ "è´¦å·ç®¡ç†" â†’ "ä¿®æ”¹å¯†ç "ã€‚

æˆ–é€šè¿‡æ•°æ®åº“ä¿®æ”¹:

```sql
-- ç”Ÿæˆæ–°å¯†ç å“ˆå¸Œ
-- ä½¿ç”¨ bcrypt å·¥å…·æˆ–åœ¨ Go ä¸­è¿è¡Œï¼š
-- hashedPassword, _ := common.Password2Hash("new_password")

UPDATE users SET password = '$2a$10$...' WHERE username = 'root';
```

**Q2: æ¸ é“ä¸€ç›´æ˜¾ç¤º"è‡ªåŠ¨ç¦ç”¨"æ€ä¹ˆåŠï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹:
1. æ¸ é“ API å¯†é’¥æ˜¯å¦æ­£ç¡®
2. æ¸ é“ä½™é¢æ˜¯å¦å……è¶³
3. ä¸Šæ¸¸æœåŠ¡æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

æ‰‹åŠ¨å¯ç”¨æ¸ é“:
- ç®¡ç†åå° â†’ æ¸ é“ç®¡ç† â†’ ç¼–è¾‘æ¸ é“ â†’ çŠ¶æ€é€‰æ‹©"å¯ç”¨"

**Q3: Token é…é¢ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ**

A:
1. ç®¡ç†å‘˜å¯ä»¥åœ¨"Token ç®¡ç†"ä¸­ç¼–è¾‘ Tokenï¼Œå¢åŠ é…é¢
2. æˆ–è€…è®¾ç½® Token ä¸º"æ— é™é…é¢"
3. ç”¨æˆ·å¯ä»¥é€šè¿‡å……å€¼å¢åŠ è´¦æˆ·é…é¢

**Q4: å¦‚ä½•æ‰¹é‡å¯¼å…¥æ¸ é“ï¼Ÿ**

A: ä½¿ç”¨"æ‰¹é‡æ·»åŠ "åŠŸèƒ½:
1. ç®¡ç†åå° â†’ æ¸ é“ç®¡ç† â†’ æ‰¹é‡æ·»åŠ 
2. è¾“å…¥å¤šä¸ª API å¯†é’¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
3. è®¾ç½®é€šç”¨é…ç½®
4. ç‚¹å‡»"æ‰¹é‡åˆ›å»º"

**Q5: å‰ç«¯å¼€å‘æ—¶ API è¯·æ±‚ 404ï¼Ÿ**

A: æ£€æŸ¥ Vite ä»£ç†é…ç½®:

```javascript
// web/vite.config.js
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:3000',
      changeOrigin: true,
    },
  },
}
```

ç¡®ä¿åç«¯æœåŠ¡åœ¨ `http://localhost:3000` è¿è¡Œã€‚

**Q6: æ•°æ®åº“è¿ç§»å¤±è´¥ï¼Ÿ**

A:
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
2. ç¡®ä¿æ•°æ®åº“ç”¨æˆ·æœ‰ CREATE TABLE æƒé™
3. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
4. å¦‚æœæ˜¯ä»æ—§ç‰ˆæœ¬å‡çº§ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ‰§è¡Œè¿ç§» SQL

**Q7: Redis è¿æ¥å¤±è´¥ï¼Ÿ**

A:
1. æ£€æŸ¥ REDIS_CONN_STRING é…ç½®
2. ç¡®ä¿ Redis æœåŠ¡æ­£å¸¸è¿è¡Œ
3. æµ‹è¯• Redis è¿æ¥:
   ```bash
   redis-cli ping
   ```
4. å¦‚æœä¸éœ€è¦ Redisï¼Œå¯ä»¥ä¸é…ç½®ï¼ˆç³»ç»Ÿä¼šä½¿ç”¨ SQLite ç¼“å­˜ï¼‰

### 10.2 æœ€ä½³å®è·µ

**1. å®‰å…¨æ€§**:

- âœ… ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
- âœ… å¯ç”¨åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰
- âœ… å®šæœŸæ›´æ–°ç³»ç»Ÿ
- âœ… ä½¿ç”¨ HTTPS
- âœ… é…ç½®é˜²ç«å¢™ï¼Œåªå¼€æ”¾å¿…è¦ç«¯å£
- âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“
- âœ… ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
- âœ… é™åˆ¶ API é€Ÿç‡
- âœ… ç›‘æ§å¼‚å¸¸è®¿é—®

**2. æ€§èƒ½ä¼˜åŒ–**:

- âœ… å¯ç”¨ Redis ç¼“å­˜
- âœ… é…ç½®æ•°æ®åº“è¿æ¥æ± 
- âœ… å®šæœŸæ¸…ç†æ—§æ—¥å¿—
- âœ… ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
- âœ… å¯ç”¨ Gzip å‹ç¼©
- âœ… ä½¿ç”¨æ‰¹é‡æ›´æ–°
- âœ… åˆç†è®¾ç½®æ¸ é“æƒé‡
- âœ… ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨

**3. å¯é æ€§**:

- âœ… é…ç½®å¤šä¸ªæ¸ é“å®ç°å†—ä½™
- âœ… å¯ç”¨æ¸ é“è‡ªåŠ¨ç¦ç”¨
- âœ… é…ç½®å¤±è´¥é‡è¯•æ¬¡æ•°
- âœ… ä½¿ç”¨è´Ÿè½½å‡è¡¡
- âœ… é…ç½®ç›‘æ§å‘Šè­¦
- âœ… å®šæœŸæµ‹è¯•æ¸ é“å¯ç”¨æ€§
- âœ… å¤‡ä»½å…³é”®é…ç½®

**4. å¼€å‘è§„èŒƒ**:

- âœ… éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒ
- âœ… ç¼–å†™å•å…ƒæµ‹è¯•
- âœ… æ·»åŠ ä»£ç æ³¨é‡Š
- âœ… ä½¿ç”¨ Git ç‰ˆæœ¬æ§åˆ¶
- âœ… Code Review
- âœ… æ–‡æ¡£åŠæ—¶æ›´æ–°

**5. è¿ç»´è§„èŒƒ**:

- âœ… ä½¿ç”¨ Docker éƒ¨ç½²
- âœ… é…ç½®æ—¥å¿—æ”¶é›†
- âœ… è®¾ç½®ç›‘æ§å‘Šè­¦
- âœ… åˆ¶å®šå¤‡ä»½è®¡åˆ’
- âœ… å‡†å¤‡åº”æ€¥é¢„æ¡ˆ
- âœ… å®šæœŸæ›´æ–°ä¾èµ–

### 10.3 æ€§èƒ½åŸºå‡†

**æµ‹è¯•ç¯å¢ƒ**:
- CPU: 4 Core
- Memory: 8GB
- Database: PostgreSQL 14
- Cache: Redis 7

**åŸºå‡†æµ‹è¯•ç»“æœ**:

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹¶å‘è¯·æ±‚ | 1000 req/s |
| å¹³å‡å“åº”æ—¶é—´ | 150ms |
| P95 å“åº”æ—¶é—´ | 300ms |
| P99 å“åº”æ—¶é—´ | 500ms |
| æ•°æ®åº“è¿æ¥æ•° | 50 |
| å†…å­˜å ç”¨ | 500MB |
| CPU ä½¿ç”¨ç‡ | 40% |

### 10.4 æ•…éšœæ’æŸ¥æŒ‡å—

**é—®é¢˜: ç³»ç»Ÿå¯åŠ¨å¤±è´¥**

æ’æŸ¥æ­¥éª¤:
1. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
   ```bash
   ./new-api 2>&1 | tee startup.log
   ```
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. æ£€æŸ¥ç«¯å£å ç”¨
   ```bash
   lsof -i:3000
   ```
4. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

**é—®é¢˜: API è¯·æ±‚è¶…æ—¶**

æ’æŸ¥æ­¥éª¤:
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
2. æ£€æŸ¥ä¸Šæ¸¸æœåŠ¡çŠ¶æ€
3. æ£€æŸ¥ç½‘ç»œè¿æ¥
4. å¢åŠ è¶…æ—¶æ—¶é—´
   ```bash
   export STREAMING_TIMEOUT=600
   ```
5. æ£€æŸ¥æ•°æ®åº“æ€§èƒ½

**é—®é¢˜: å†…å­˜å ç”¨è¿‡é«˜**

æ’æŸ¥æ­¥éª¤:
1. å¯ç”¨ pprof åˆ†æ
   ```bash
   go tool pprof http://localhost:8005/debug/pprof/heap
   ```
2. æ£€æŸ¥ Goroutine æ³„æ¼
3. ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
4. å¢åŠ å†…å­˜é™åˆ¶
5. å®šæœŸé‡å¯æœåŠ¡

**é—®é¢˜: æ¸ é“è¯·æ±‚å¤±è´¥ç‡é«˜**

æ’æŸ¥æ­¥éª¤:
1. æ£€æŸ¥æ¸ é“çŠ¶æ€
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
3. æµ‹è¯•æ¸ é“è¿é€šæ€§
4. æ£€æŸ¥ API å¯†é’¥
5. æŸ¥çœ‹ä¸Šæ¸¸æœåŠ¡çŠ¶æ€
6. è°ƒæ•´é‡è¯•ç­–ç•¥

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ | å¿…éœ€ |
|--------|------|--------|------|
| SQL_DSN | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² | local | å¦ |
| REDIS_CONN_STRING | Redis è¿æ¥å­—ç¬¦ä¸² | - | å¦ |
| SESSION_SECRET | Session å¯†é’¥ | random | å¤šæœºéƒ¨ç½²å¿…éœ€ |
| CRYPTO_SECRET | åŠ å¯†å¯†é’¥ | - | Redis å¿…éœ€ |
| PORT | æœåŠ¡ç«¯å£ | 3000 | å¦ |
| GIN_MODE | Gin è¿è¡Œæ¨¡å¼ | release | å¦ |
| ERROR_LOG_ENABLED | é”™è¯¯æ—¥å¿— | false | å¦ |
| LOG_CONSUME_ENABLED | æ¶ˆè´¹æ—¥å¿— | true | å¦ |
| STREAMING_TIMEOUT | æµå¼è¶…æ—¶ï¼ˆç§’ï¼‰ | 300 | å¦ |
| AZURE_DEFAULT_API_VERSION | Azure API ç‰ˆæœ¬ | 2025-04-01-preview | å¦ |
| CHANNEL_UPDATE_FREQUENCY | æ¸ é“æ›´æ–°é¢‘ç‡ï¼ˆåˆ†é’Ÿï¼‰ | - | å¦ |
| BATCH_UPDATE_ENABLED | æ‰¹é‡æ›´æ–° | false | å¦ |
| BATCH_UPDATE_INTERVAL | æ‰¹é‡æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰ | 60 | å¦ |
| ENABLE_PPROF | æ€§èƒ½åˆ†æ | false | å¦ |
| SYNC_FREQUENCY | åŒæ­¥é¢‘ç‡ï¼ˆç§’ï¼‰ | 60 | å¦ |
| MEMORY_CACHE_ENABLED | å†…å­˜ç¼“å­˜ | false | å¦ |

### B. API ç«¯ç‚¹å‚è€ƒ

è¯¦ç»† API æ–‡æ¡£è¯·è®¿é—®å®˜æ–¹æ–‡æ¡£: https://docs.newapi.pro/api

**è®¤è¯ç›¸å…³**:
- POST /api/user/login - ç™»å½•
- POST /api/user/register - æ³¨å†Œ
- POST /api/user/logout - ç™»å‡º
- GET /api/user/self - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**æ¸ é“ç®¡ç†**:
- GET /api/channel - è·å–æ¸ é“åˆ—è¡¨
- POST /api/channel - åˆ›å»ºæ¸ é“
- PUT /api/channel - æ›´æ–°æ¸ é“
- DELETE /api/channel/:id - åˆ é™¤æ¸ é“
- POST /api/channel/test - æµ‹è¯•æ¸ é“

**Token ç®¡ç†**:
- GET /api/token - è·å– Token åˆ—è¡¨
- POST /api/token - åˆ›å»º Token
- PUT /api/token - æ›´æ–° Token
- DELETE /api/token/:id - åˆ é™¤ Token

**ä¸­ç»§ API**:
- POST /v1/chat/completions - å¯¹è¯æ¥å£
- POST /v1/images/generations - å›¾åƒç”Ÿæˆ
- POST /v1/audio/speech - TTS è¯­éŸ³åˆæˆ
- POST /v1/audio/transcriptions - STT è¯­éŸ³è¯†åˆ«
- POST /v1/embeddings - å‘é‡åŒ–

### C. æ”¯æŒçš„ AI æä¾›å•†åˆ—è¡¨

| æä¾›å•† | Type | è¯´æ˜ |
|--------|------|------|
| OpenAI | 1 | GPT ç³»åˆ— |
| Claude | 2 | Anthropic Claude |
| Azure OpenAI | 3 | Azure OpenAI |
| Gemini | 4 | Google Gemini |
| é˜¿é‡Œé€šä¹‰åƒé—® | 14 | é˜¿é‡Œäº‘ |
| ç™¾åº¦æ–‡å¿ƒä¸€è¨€ | 15 | ç™¾åº¦ |
| æ™ºè°± GLM | 16 | æ™ºè°± AI |
| è®¯é£æ˜Ÿç« | 18 | è®¯é£ |
| è…¾è®¯æ··å…ƒ | 19 | è…¾è®¯äº‘ |
| DeepSeek | 20 | DeepSeek |
| MiniMax | 21 | MiniMax |
| æœˆä¹‹æš—é¢ Kimi | 22 | æœˆä¹‹æš—é¢ |
| é›¶ä¸€ä¸‡ç‰© | 23 | é›¶ä¸€ä¸‡ç‰© |
| ... | ... | å…± 30+ æä¾›å•† |

å®Œæ•´åˆ—è¡¨è¯·æŸ¥çœ‹: `constant/channel.go`

### D. å‚è€ƒèµ„æº

**å®˜æ–¹èµ„æº**:
- é¡¹ç›®åœ°å€: https://github.com/QuantumNous/new-api
- å®˜æ–¹æ–‡æ¡£: https://docs.newapi.pro
- æ›´æ–°æ—¥å¿—: https://github.com/QuantumNous/new-api/releases

**ç¤¾åŒºèµ„æº**:
- é—®é¢˜åé¦ˆ: https://github.com/QuantumNous/new-api/issues
- è®¨è®ºåŒº: https://github.com/QuantumNous/new-api/discussions

**ç›¸å…³é¡¹ç›®**:
- One API: https://github.com/songquanpeng/one-api
- Midjourney Proxy: https://github.com/novicezk/midjourney-proxy
- neko-api-key-tool: https://github.com/Calcium-Ion/neko-api-key-tool

**æŠ€æœ¯æ–‡æ¡£**:
- Go å®˜æ–¹æ–‡æ¡£: https://go.dev/doc
- Gin æ¡†æ¶: https://gin-gonic.com/docs
- GORM: https://gorm.io/docs
- React: https://react.dev
- Semi Design: https://semi.design
- Vite: https://vitejs.dev

---

## ç»“è¯­

æœ¬æ‰‹å†Œè¯¦ç»†ä»‹ç»äº† New API é¡¹ç›®çš„æ¶æ„ã€å¼€å‘æµç¨‹å’Œæœ€ä½³å®è·µã€‚å¸Œæœ›èƒ½å¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ï¼Œé«˜æ•ˆåœ°è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿åœ¨ GitHub ä¸Šæäº¤ Issue æˆ– Pull Requestã€‚

**ç¥å¼€å‘æ„‰å¿«ï¼** ğŸ‰

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Claude
**æœ€åæ›´æ–°**: 2025-11-29
**ç‰ˆæœ¬**: 1.0
