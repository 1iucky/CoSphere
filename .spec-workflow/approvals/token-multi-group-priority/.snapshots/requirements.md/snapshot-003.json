{
  "id": "snapshot_1764508130725_ha8y1cya8",
  "approvalId": "approval_1764507927651_agklindap",
  "approvalTitle": "需求规格文档 - 令牌多分组优先级管理 (修订版)",
  "version": 3,
  "timestamp": "2025-11-30T13:08:50.725Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# 需求规格文档: 令牌多分组优先级管理\n\n**项目**: New API - AI网关与资产管理系统\n**功能**: 令牌多分组优先级管理\n**创建日期**: 2025-11-30\n**文档状态**: 草稿\n\n---\n\n## 1. 概述\n\n### 1.1 功能背景\n\n当前令牌管理系统仅支持单一分组配置,无法满足以下场景需求:\n- 用户希望为令牌配置多个备用分组,提高服务可用性\n- 用户需要控制不同分组的使用优先级,优先使用成本更低或性能更好的分组\n- 系统在主分组不可用时,需要自动降级到备用分组\n\n### 1.2 业务价值\n\n1. **提高服务可用性**: 多分组配置提供自动故障转移能力\n2. **优化成本控制**: 通过优先级控制,优先使用低成本分组\n3. **改善用户体验**: 减少因单点故障导致的服务中断\n4. **灵活性提升**: 用户可根据实际需求灵活配置分组策略\n\n### 1.3 目标用户\n\n- **终端用户**: 使用令牌调用AI模型服务的开发者\n- **系统管理员**: 配置和管理令牌分组的运维人员\n\n---\n\n## 2. 功能需求\n\n### 2.1 用户故事\n\n#### US-1: 创建多分组令牌\n**作为** 系统用户\n**我想要** 在创建令牌时选择多个分组并设置优先级\n**以便** 实现服务的高可用和成本优化\n\n**验收标准**:\n- GIVEN 用户在创建令牌页面\n- WHEN 用户选择分组时\n- THEN 系统应支持多选分组\n- AND 用户可以通过拖动调整分组的优先级顺序\n- AND 系统实时显示当前的优先级顺序\n- AND 分组选择器附近显示功能说明提示文本\n- AND 自动智能分组开关附近显示功能说明提示文本\n- AND 保存后能够正确存储多分组配置\n\n#### US-2: 编辑令牌分组优先级\n**作为** 系统用户\n**我想要** 修改现有令牌的分组配置和优先级\n**以便** 根据实际运行情况调整分组策略\n\n**验收标准**:\n- GIVEN 用户在编辑令牌页面\n- WHEN 用户修改分组配置时\n- THEN 系统显示当前已配置的分组及其优先级\n- AND 用户可以添加、删除分组\n- AND 用户可以调整分组优先级顺序\n- AND 分组选择器附近显示功能说明提示文本\n- AND 自动智能分组开关附近显示功能说明提示文本\n- AND 修改后能够正确更新数据库\n\n#### US-3: 查看令牌分组配置\n**作为** 系统用户\n**我想要** 在令牌列表中清晰看到每个令牌的分组配置\n**以便** 快速了解令牌的分组策略\n\n**验收标准**:\n- GIVEN 用户在令牌列表页面\n- WHEN 用户浏览令牌列表时\n- THEN 每个令牌显示其配置的所有分组\n- AND 分组按优先级顺序展示 (如: group1 > group2 > group3)\n- AND 优先级顺序清晰可读\n\n#### US-4: 多分组优先级转发\n**作为** 系统\n**我想要** 按照用户设置的分组优先级顺序进行请求转发\n**以便** 实现智能的负载分发和故障转移\n\n**验收标准**:\n- GIVEN 令牌配置了多个分组 [group1(priority=1), group2(priority=2), group3(priority=3)]\n- WHEN 用户使用该令牌发起请求\n- THEN 系统首先尝试使用 group1 的渠道\n- AND 如果 group1 中不存在请求的模型,自动尝试 group2\n- AND 如果 group1 请求失败/异常,自动尝试 group2\n- AND 依此类推,直到成功或所有分组都失败\n- AND 每次降级都应记录日志\n\n#### US-5: 自动智能分组\n**作为** 系统用户\n**我想要** 启用自动智能分组功能\n**以便** 在配置的分组都失败时,系统自动从其他可用分组中选择\n\n**验收标准**:\n- GIVEN 令牌配置了自动智能分组为\"开启\"\n- WHEN 所有配置的分组都无法提供服务时\n- THEN 系统自动从其他可用分组中按费率从低到高的顺序尝试\n- AND 成功响应请求后记录实际使用的分组\n- AND 如果自动智能分组为\"关闭\",则直接返回错误\n\n---\n\n## 3. 非功能需求\n\n### 3.1 性能要求\n\n- **响应时间**: 分组选择逻辑不应增加超过 50ms 的额外延迟\n- **并发处理**: 支持至少 1000 QPS 的令牌验证和分组选择\n- **缓存机制**:\n  - 利用现有 Redis 缓存机制存储令牌信息(包括 GroupPriorities 字段)\n  - 令牌验证优先从 Redis 读取,缓存未命中才查询数据库\n  - 令牌更新/删除操作同步更新 Redis 缓存\n  - 确保缓存与数据库数据一致性\n- **数据库查询**: 在 Redis 启用的情况下,单次令牌验证通常只需 0 次数据库查询(缓存命中),缓存未命中时不超过 1 次查询\n\n### 3.2 可用性要求\n\n- **向后兼容**: 现有单分组令牌应能正常工作\n- **数据迁移**: 提供平滑的数据迁移方案,不影响现有令牌\n- **降级策略**: 多分组逻辑失败时,应降级到单分组模式\n\n### 3.3 可维护性要求\n\n- **代码清晰**: 新增逻辑应遵循现有代码风格和架构\n- **日志完整**: 记录每次分组选择和降级过程\n- **配置灵活**: 自动智能分组可在令牌级别配置\n\n### 3.4 安全性要求\n\n- **权限控制**: 用户只能配置自己有权访问的分组\n- **参数验证**: 前后端都需验证分组配置的合法性\n- **注入防护**: 防止 SQL 注入和 JSON 注入攻击\n\n---\n\n## 4. 约束条件\n\n### 4.1 技术约束\n\n- **后端**: 基于现有 Go + Gin 框架,不引入新的依赖库\n- **前端**: 基于现有 React + Semi Design,尽量使用现有组件\n- **数据库**: 兼容 PostgreSQL, MySQL 和 SQLite\n- **存储格式**: GroupPriorities 字段使用 JSON 字符串存储\n\n### 4.2 业务约束\n\n- **最大分组数**: 单个令牌最多配置 10 个分组\n- **优先级范围**: 优先级从 1 开始,数字越小优先级越高\n- **数据一致性**: Group 字段保留,用于向后兼容和单分组场景\n\n### 4.3 时间约束\n\n- **开发周期**: 预计 2-3 个开发迭代\n- **测试周期**: 充分的单元测试和集成测试\n- **发布策略**: 灰度发布,逐步推广\n\n---\n\n## 5. 依赖关系\n\n### 5.1 功能依赖\n\n- **依赖**: 现有令牌管理系统 (`model/token.go`, `controller/token.go`)\n- **依赖**: 现有渠道选择逻辑 (`service/channel_select.go`, `middleware/distributor.go`)\n- **依赖**: 前端令牌管理界面 (`web/src/components/table/tokens/`)\n\n### 5.2 数据依赖\n\n- **依赖**: 用户分组配置 (user.group)\n- **依赖**: 渠道分组配置 (channel.group)\n- **依赖**: 模型可用性数据\n\n---\n\n## 6. 风险分析\n\n### 6.1 技术风险\n\n| 风险 | 影响 | 概率 | 缓解措施 |\n|------|------|------|----------|\n| 多分组逻辑增加转发延迟 | 中 | 中 | 优化代码,增加缓存,性能测试验证 |\n| 数据迁移失败 | 高 | 低 | 编写可回滚的迁移脚本,充分测试 |\n| 分组降级逻辑复杂 | 中 | 中 | 编写详细的单元测试和集成测试 |\n| 向后兼容问题 | 高 | 低 | 保留 Group 字段,双写逻辑 |\n\n### 6.2 业务风险\n\n| 风险 | 影响 | 概率 | 缓解措施 |\n|------|------|------|----------|\n| 用户配置错误导致服务不可用 | 高 | 中 | 前端校验,提供配置建议,降级开关 |\n| 费率计算逻辑需要调整 | 中 | 低 | 记录实际使用的分组,便于审计 |\n| 现有用户不理解新功能 | 中 | 高 | 提供文档,默认保持单分组行为 |\n\n---\n\n## 7. 验收标准\n\n### 7.1 功能验收\n\n- [ ] 用户能够在创建/编辑令牌时选择多个分组\n- [ ] 用户能够通过拖动调整分组优先级\n- [ ] 表单中相关字段附近显示清晰的功能说明\n- [ ] 令牌列表正确显示多分组配置\n- [ ] 系统按优先级顺序进行分组转发\n- [ ] 分组不可用时自动降级到下一个分组\n- [ ] 自动智能分组开关正常工作\n- [ ] 现有单分组令牌不受影响\n\n### 7.2 性能验收\n\n- [ ] 多分组选择逻辑延迟 < 50ms\n- [ ] 支持 1000 QPS 并发处理\n- [ ] Redis 缓存命中率 ≥ 95%\n- [ ] 数据库查询次数未显著增加\n\n### 7.3 质量验收\n\n- [ ] 单元测试覆盖率 ≥ 80%\n- [ ] 集成测试覆盖所有主要场景\n- [ ] 代码审查通过\n- [ ] 文档完整\n\n---\n\n## 8. 未来扩展\n\n### 8.1 可能的增强功能\n\n- **智能分组推荐**: 基于历史数据推荐最优分组配置\n- **分组性能监控**: 展示每个分组的成功率、延迟等指标\n- **分组配额管理**: 为每个分组设置独立的配额限制\n- **分组时段策略**: 根据时间段自动切换分组优先级\n\n### 8.2 暂不实现的功能\n\n- **分组权重配置**: 按权重随机选择分组 (暂不需要)\n- **分组条件路由**: 根据请求内容动态选择分组 (复杂度高)\n- **跨令牌分组共享**: 多个令牌共享同一套分组配置 (需求不明确)\n\n---\n\n## 附录\n\n### A. 术语表\n\n- **分组 (Group)**: 渠道的逻辑分组,如 \"default\", \"gpt-4-group\" 等\n- **优先级 (Priority)**: 分组的使用顺序,数字越小优先级越高\n- **降级 (Fallback)**: 当前分组不可用时,自动切换到备用分组\n- **费率 (Ratio)**: 分组的计费倍率,影响使用成本\n\n### B. 参考文档\n\n- [现有令牌管理文档](../../../docs/)\n- [分组管理文档](../../../docs/)\n- [CLAUDE.md 项目规范](../../../CLAUDE.md)\n\n---\n\n**文档修订历史**:\n\n| 版本 | 日期 | 作者 | 修改内容 |\n|------|------|------|----------|\n| 0.1 | 2025-11-30 | Claude Code | 初始版本 |\n| 0.2 | 2025-11-30 | Claude Code | 根据审批反馈修订:<br/>1. 将\"自动分组降级开关\"改为\"自动智能分组\"<br/>2. 补充 Redis 缓存机制说明<br/>3. 增加表单字段功能说明要求 |\n",
  "fileStats": {
    "size": 9360,
    "lines": 269,
    "lastModified": "2025-11-30T13:04:38.710Z"
  },
  "comments": []
}